<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>Oh also W,A,S,D moves the camera.</title>
    <link href="/stylesheets/screen.css" media="all" rel="stylesheet" type="text/css"/>
    <script language="javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js" type="text/javascript"></script><script language="javascript" src="javascripts/jquery.hotkeys.js" type="text/javascript"></script><script language="javascript" src="javascripts/key_status.js" type="text/javascript"></script><script language="javascript" src="javascripts/util.js" type="text/javascript"></script><script language="javascript" src="javascripts/sprite.js" type="text/javascript"></script><script language="javascript" src="javascripts/sound.js" type="text/javascript"></script>
  </head>
  <body>
    <h1>Hit H for controls. </h1>
    <script type='text/javascript'>
      //<![CDATA[
        var CANVAS_WIDTH = 900;
        var CANVAS_HEIGHT = 640;
		var MAP_WIDTH = 120;
        var MAP_HEIGHT = 80;
        var FPS = 30;
		//var keychart = ["w","a","d","s","up","right","down","left","m","n","shift"];
		var darkgrasssprite = Sprite("darkgrass");
		var grasssprite = Sprite("grass");
		var watersprite = Sprite("water");
		var lavasprite = Sprite("lava");
		var rocksprite = Sprite("stone2");
		var bricksprite = Sprite("brick");
		var dirtsprite = Sprite("dirt");
		var crystalsprite = Sprite("crystalfloor");
		var mudsprite = Sprite("mud");
		var obsidiansprite = Sprite("obsidian");
		var mossysprite = Sprite("mossy");
		var stonesprite = Sprite("stone");
		var edsprite = Sprite("cursor");
		Mode = 1;
		var playerBullets = [];
		//var keyboard = [];
		//for (l=0;l<10;l++){keyboard.push(akey(keychart[l]));}

		var canX=[];
		var canY=[];
        var canvasElement = $("<canvas width='" + CANVAS_WIDTH + 
          "' height='" + CANVAS_HEIGHT + "'></canvas");
        var canvas = canvasElement.get(0).getContext("2d");
        canvasElement.appendTo('body');

		
		//canvas.globalAlpha = 0.85;//todo: something with this
	
			
		function akey(k) {  //k,wkey?
		    k = k || "space";
			this.key =k;
			this.aflag=false;
			this.check= function(){
				if (keydown[this.key]) { 
					this.aflag=true;
					return false;
				}
				if((!keydown[this.key]) && (this.aflag==true)){
					this.aflag=false;
					return true;
				}
		    };
			return this;
		}
		
		function aMouse() {
			this.mX= 0;
			this.mY= 0;
			this.tx= 0;
			this.ty= 0;
			this.mDelta=0;
			this.wasWheeled= false;
			this.mouseIsDown= false;
		
			
			mouseXY= function(e) {
				if (!e) var e = event;
				mX = e.pageX - canvasElement.get(0).offsetLeft;
				mY = e.pageY - canvasElement.get(0).offsetTop;
				//alert("mousemoved");
				canX=mX;
				canY=mY;
			
				//showPos();
			};
			
			this.startStroke= function(e) {
				if (!e) var e = event;
				mDelta=e.wheelDelta;
				wasWheeled=true;
				
			};
			
			this.touchXY= function(e) { //touchsreen
			if (!e) var e = event;
			e.preventDefault();
			mX = e.targetTouches[0].pageX - canvasElement.get(0).offsetLeft;
			mY = e.targetTouches[0].pageY - canvasElement.get(0).offsetTop;
			//showPos();
			};
			
			mouseUp= function(e) {
			if (!e) var e = event;
			mouseIsDown = 0;
			mouseXY(e);
			};

			touchUp= function() {
			mouseIsDown = 0;
			// no touch to track, so just show state
			//do something.
			};

			mouseDown= function(e) {
			if (!e) var e = event;
			mouseIsDown = 1;
			mouseXY(e);
			tx=Math.floor(this.mX/16);
			ty=Math.floor(this.mY/16);

			};

			this.touchDown= function() {
			mouseIsDown = 1;
			//do something();
			};
			return this;
        }
		
		var Mouse= aMouse();
		
		canvasElement.get(0).addEventListener("mousewheel",Mouse.startStroke,false);
		canvasElement.get(0).addEventListener("mousemove", Mouse.mouseXY, false);
		canvasElement.get(0).addEventListener("mousedown", Mouse.mouseDown, false);

		/*canvasElement.get(0).addEventListener("touchstart", Mouse.touchDown, false);
		canvasElement.get(0).addEventListener("touchmove", Mouse.touchXY, true);   //TODO: Implement touch screen functions
        canvasElement.get(0).addEventListener("touchend", Mouse.touchUp, false);*/
 
		document.body.addEventListener("mouseup", Mouse.mouseUp, false);
		//document.body.addEventListener("touchcancel", Mouse.touchUp, false);
		
		var savekey=new akey("o");
		var loadkey=new akey("l");
		var wkey=new akey("w");
		var aakey=new akey("a");
		var skey=new akey("s");
		var dkey=new akey("d");
	    var upkey=new akey("up");
		var rightkey=new akey("right");
		var downkey=new akey("down");
		var leftkey=new akey("left");
		var modekey=new akey("m");
		var nkey=new akey("n");
		var shiftkey=new akey("shift");
		var helpkey=new akey("h");
		var slowkey=new akey("b");
		var cmousekey=new akey("v");
	    var defkey=new akey("j");
		
		var camera = {
		    x: 0,
			y: 0,
			width: 52,
			height: 40,
			center: function(targ) {
			    tx=targ.x-26;
				ty=targ.y-20;
				if (tx<0) {tx=0;}
				if (ty<0) {ty=0;}
				if (tx>MAP_WIDTH-52) {tx=MAP_WIDTH-52;}
				if (ty>MAP_HEIGHT-40) {ty=MAP_HEIGHT-40;}

				this.x=tx;
				this.y=ty;
			},
			check: function() {
			    this.x.clamp(0, MAP_WIDTH-52);
				this.y.clamp(0, MAP_HEIGHT-40);
			},
			rX: function(fx)
			{
				return fx-this.x;
			},
			rY: function(fy)
			{
				return fy-this.y;
			}
		};
				
        var bColors = ["#008000","#006400", "#FF4500", "#000080", "#696969", "#800080", "#808000", "#A52A2A", "#8B4513", "#FFDEAD", "#FFFF40","#000080" , "#FFFF80"];
		function makeNewTile() { 
		    var tile = {
                width: 16,
				height: 16,
				x: 0,
				y: 0,
				color: "#FFC020",
				data: 0,
				draw: function(cam) { 
				    if(this.data==0){
					   grasssprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.data==1){
					   darkgrasssprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.data==2){
					   lavasprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.data==3){
					   watersprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.data==4){
					   stonesprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.data==5){
					   obsidiansprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.data==6){
					   mudsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.data==7){
					   bricksprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.data==8){
					   dirtsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.data==9){
					   crystalsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16); //todo: duplicate! add new type
					}else if(this.data==10){
					   crystalsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.data==11){
					   darkgrasssprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else{
				       canvas.fillStyle = bColors[this.data]; 
					   canvas.fillRect((this.x-cam.x)*this.width, (this.y-cam.y)*this.height, this.width, this.height);
					}
				}
				};
			
            return tile;
		};
		
        var player = {
          color: "#00A",
          x: 30,
          y: 20,
		  dir: 0,
		  type: 0,
          width: 32,
          height: 32,
          draw: function(cam) {
            canvas.fillStyle = bColors[this.type];
            canvas.fillRect((this.x-cam.x)*16, (this.y-cam.y)*16, this.width, this.height);
          },
		  getKeys: function(merp) {
			  if(keydown.left) {
			    this.dir=3;
			    if ((merp.canWalk([this.x-1],[this.y])) && (merp.canWalk([this.x-1],[this.y+1]))) {this.x -= 1;}
			  }
			
			  if(keydown.right) {
			    this.dir=1;
				if ((merp.canWalk([this.x+2],[this.y])) && (merp.canWalk([this.x+2],[this.y+1]))) {this.x += 1;}
			  }
			  
			  if(keydown.up) {
			    this.dir=0;
				if ((merp.canWalk([this.x],[this.y-1])) && (merp.canWalk([this.x+1],[this.y-1]))) {this.y -= 1;}
			  }
			
			  if(keydown.down) {
			    this.dir=2;
				if ((merp.canWalk([this.x],[this.y+2])) && (merp.canWalk([this.x+1],[this.y+2]))) {this.y += 1;}
			  }
			  this.x = this.x.clamp(0, MAP_WIDTH-1);
			  this.y = this.y.clamp(0, MAP_HEIGHT-1);
		  }
        
        };
		
		 var edcursor = {
          color: "#00A",
          x: 1,
          y: 1,
		  slow: false,
		  mouse: false,
		  size: 1, //TODO: add for loops to draw, placement to make larger brush size, center it?
		  type: 1,
          width: 16,
          height: 16,
          draw: function(cam) {
            	    if(this.type==0){
					   grasssprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.type==1){
					   darkgrasssprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.type==2){
					   lavasprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.type==3){
					   watersprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.type==4){
					   stonesprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.type==5){
					   obsidiansprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.type==6){
					   mudsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.type==7){
					   bricksprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.type==8){
					   dirtsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.type==9){
					   crystalsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.type==10){
					   crystalsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16); //todo duplicate
					}else if(this.type==11){
					   darkgrasssprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else{
				       canvas.fillStyle = bColors[this.data]; 
					   canvas.fillRect((this.x-cam.x)*this.width, (this.y-cam.y)*this.height, this.width, this.height);
					}
					edsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
          },
		  getKeys: function() {
		  	  if(nkey.check()) { 
				  this.type++;
				  if (this.type > 9) {this.type=0;}
			  }
			  
			  if(slowkey.check()) {
				this.slow=!this.slow;
			  }
			  
			  if(cmousekey.check()) {
				this.mouse=!this.mouse;
			  }
			  
			  
			  
			  if (this.slow) {
			  	if(leftkey.check()) {
					this.x -= 1;
				  }
				
				  if(rightkey.check()) {
					this.x += 1;
				  }
				  
				  if(upkey.check()) {
					this.y -= 1;
				  }
				
				  if(downkey.check()) {
					this.y += 1;
				  }
				  
			  }else{
			
				  if(keydown.left) {
					this.x -= 1;
				  }
				
				  if(keydown.right) {
					this.x += 1;
				  }
				  
				  if(keydown.up) {
					this.y -= 1;
				  }
				
				  if(keydown.down) {
					this.y += 1;
				  }
			  }
			  this.x = this.x.clamp(0, MAP_WIDTH-1);
			  this.y = this.y.clamp(0, MAP_HEIGHT-1);
		  }
        };
        
		function Map(I) {
            I = I || {};
		    var i = 0;
			var j = 0;
		    I.active = true;
            I.color = "#00A";
            I.tiles = new Array(MAP_WIDTH);
			for( i=0; i<MAP_WIDTH; i++ ) { I.tiles[i] = new Array(MAP_HEIGHT); }
		    for (i=0;i<MAP_WIDTH; i++){
		        for (j=0;j<MAP_HEIGHT; j++){
					I.tiles[i][j]= makeNewTile();
					I.tiles[i][j].x=i;
					I.tiles[i][j].y=j;
				}
			}
            I.width = MAP_WIDTH;
            I.height = MAP_HEIGHT;
            I.draw = function(cam) {
				cam.check();
				for (i=cam.x;i<cam.x+cam.width; i++){
					for (j=cam.y;j<cam.y+cam.height; j++){
						I.tiles[i][j].draw(cam);
					}
				}
			};
		    I.saveTiles = function (name) {
			    //var myString = JSON.stringify(I.tiles); //!?!
				var tempstring= "";
				for (i=0;i<MAP_WIDTH; i++){
					for (j=0;j<MAP_HEIGHT; j++){
					    /*tempo=" ";
						if (I.tiles[i][j].data <10)
						{
						    tempo+=I.tiles[i][j].data;
							tempstring = tempstring +tempo;
						}else*/ {tempstring = tempstring +I.tiles[i][j].data;}
						//tempstring += ","
					}
				}
				localStorage.setItem(name, tempstring);
			    //alert (tempstring);
			};
		    I.loadDefaultTiles = function () {
				tempstring="000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005555555555555500000000000000000000000000000000000000000000000000000000000000000059999999999995000000000000000000000000077777777777770000000000000000000000000000599999999999950000000000000000000000000744444444444700000000000000000000000000005999999999999500000000000000000000000007444444444447000000000000000000000000000059999999999995000000000000000000000000074444444444470011111000000000000000000000599999999999950000000000000000000000000744444444444700111110000000000000000000005999999999999500000000000000000000000007444444444447444444444444444444444444444499999999999995000000000000000000000000074444444444444444444444444444444444444444999999999999950000000000000000000000000744444444444444444444444444444444444444449999999999999500000000000000000000000007444444444447444444444444444444444444444459999999999995000000000000000000000000074444444444470011111000000444000000000000599999999999950000000000000000000000000744444444444700111110000004440000000000005999999999999500000000000000000000000007444444444447000000000000044400000000000059999999999995000000000000000000000000074444444444470000000000000444000000000000555555555555550000000000000000000000000777777777777700000000000004440000000000000000000000000000000000000000000000000000000000000000000000000000044400000000000000000000000000000000000000000000000000000000000000000000000000000444000000000000000000000000000000000000000000000000000000000000000000000000000004440000000000000000000000000000000000000000000000000000000000000000000000000000044400000000000000000000000000000000000000000000000000000000000000000000000000000444000000000000000000000000000000000000000000000000000000000000000000000000033334443333000000000000000000000000000000000000000000000000000000000000000000000333344433330000000000000000000000000000000000000000000000000077777777770000000003333444333300000000000000000000000000000000000000000000000007744444444700000000033334443333000000000000000000000000000000000000000000000000074444444447000000000333344433330000000000000000000000000000000000000000000000000744444444477000000003333444333300000000000000000000000000000000000000000000000007444444444440000000033334443333000000000000000000000000000000000000000000000000074444444444444444444444444433330000000000000000000000000000000000000000000000000744444444444444444444444444333300000000000000000000000000000000000000000000000007444444444440000000033334443333000000000000000000000000000000000000000000000000074444444444700000000333344433330000000000000000000000000000000000000000000000000744444444447000000003333444333300000000000000000000000000000000000000000000000007444444444470000000033334443333000000000000000000000000000000000000000000000000007444444444700000000333344433330000000000000000000000000000000000000000000000000074444444447000000003333444333300000000000000000000000000000000000000000000000000777777777770000000033334443333000000000000000000000000000000000000000000000000000000000000000000000333344433330000000000000000000000000000000000000000000000000000000000000000000003333444333300000000000000000000000000000000000000000000000000000000000000000000000004440000000000000000000000000000000000000000000000000000000000000000000000000000044400000000000000000000000000000000000000000000000000000000000000000000000000000444000000000000000000000000000000000000000000000000000000000000000000000000000004440000000000000000000000000000000000000000000000000000000000000000000000000000044400000000000000005555555555555555555000000000000000000000000000000888888888880444000000000000000054444444444444444450000000000000000000000000000008666666666800000000000000000000044444444444444444500000000000000000000000000000086666666668000000000000000000000444444444444444445500000000000000000000000000000866666666600000000000000000000004444444444444444445000000000000000000000000000008666666666000000000000000000000044444444444444444450000000000000000000000000000086666666668000000000000000000005444444444444444444500000000000000000000000000000866666666680000000000000000000054444444444444444445000000000000000000000000000008666666666800000000000000000000544444444444444444450000000000000000000000000000086666666668000000000000000000005444444444444444444500000000000000000000000000000888888888880000000000000000000054444444444444444445000000000000000000000000000000000000000000000000000000000000544444444444444444450000000000000000000000000000000000000000000000000000000000005444444444444444444450000000000000000000000000000000000000000000000000000000000054444444444444444444500000000000000000000000000000000000000000000000000000000000544444444444444444445000000000000000000000000000000000000000000000000000000000005444444444444444444450000000000000000000000000000000000000000000000000000000000055555555555555555555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000111100000000000000000000000000000000000000000000000000000000000000000000000000001111100000000000000000000000000000000000000000000000000000000000000000000000000011111888888800000000000000000000000000000000000000000000000000000000000000000000111110000000000000000000000000000000000000000000000000000000000000000000000000001111100000000000000000000000000000000000000000000000000000000000000000000000000011111888888000000000000000000000000000000000000000000000000000000000000000000000111110000000000000000000000000000000000000000000000000000000000000000000000000001111188888880000000000000000000000000000000000000000000000000000000000000000000011111000000000000000000000000000000000000000000000000000000000000000000000000000011100000000000000000000000000000000000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
				for (i=0;i<MAP_WIDTH; i++){
					for (j=0;j<MAP_HEIGHT; j++){
						I.tiles[i][j].data = tempstring[j+MAP_HEIGHT*i];
					}
				}
			};
		    I.loadTiles = function (name) {
				tempstring=localStorage.getItem(name);
				for (i=0;i<MAP_WIDTH; i++){
					for (j=0;j<MAP_HEIGHT; j++){
						I.tiles[i][j].data = tempstring[j+MAP_HEIGHT*i];
					}
				}
			};
		    I.setTile = function (x,y,data) {
		       I.tiles[x][y].data = data;
			};
		    I.canWalk = function (x,y) {
		      if ((I.tiles[x][y].data ==0)  || (I.tiles[x][y].data ==1 ) || (I.tiles[x][y].data ==4) || (I.tiles[x][y].data ==6)|| (I.tiles[x][y].data ==9)) {
				return true;
			  }else {return false;}
		    };
			I.drawRadar= function (cam,x,y) {
				cam.check();
				for (i=0;i<MAP_WIDTH; i++){
					for (j=0;j<MAP_HEIGHT; j++){
						  canvas.fillStyle = bColors[I.tiles[i][j].data];
						  canvas.fillRect(x+i*2, y+j*2, 2, 2);
          
					}
				}
			};
		    return I;
        }
		
		
        function Bullet(I) {
          I.active = true;
        
          if(I.dir==0){
			I.xVelocity = 0;
			I.yVelocity = -I.speed;
		  }else if(I.dir==1){
			I.xVelocity = +I.speed;
			I.yVelocity = 0;
		  }else if(I.dir==2){
			I.xVelocity = 0;
			I.yVelocity = +I.speed;
		  }else if(I.dir==3){
			I.xVelocity = -I.speed;
			I.yVelocity = 0;
		  }
          I.width = 3;
          I.height = 3;
		  I.dir = 1;
          I.color = "#000";
        
          I.inBounds = function() {
            return I.x >= 0 && I.x <= MAP_WIDTH &&
              I.y >= 0 && I.y <= MAP_HEIGHT;
          };
        
          I.draw = function(cam) {
            canvas.fillStyle = this.color;
            canvas.fillRect((this.x-cam.x)*16, (this.y-cam.y)*16, this.width, this.height);
          };
          
          I.update = function(merp) {
            I.x += I.xVelocity;
            I.y += I.yVelocity;
        
            I.active = I.active && I.inBounds();
			if((I.x>MAP_WIDTH-1) || (I.y>MAP_HEIGHT-1) || (I.x<0) || (I.y<0)) {
				I.active=false;
			}else if(!merp.canWalk([I.x],[I.y])) {I.active=false;} //todo:play a ding sound, change to merp.canflyover?
			
          };
        
          I.explode = function() {
            this.active = false;
            // TODO: Add an explosion graphic
          };
		  
      
          return I;
        }
        
        enemies = [];
        maps = [];
		maps.push(Map());
        function Enemy(I) {
          I = I || {};
        
          I.active = true;
          I.age = Math.floor(Math.random() * 128);
          
          I.color = "#A2B";
        
          I.x = 5
          I.y = 5;
          I.xVelocity = 0
          I.yVelocity = 1;
        
          I.width = 32;
          I.height = 32;
        
          I.inBounds = function() {
            return I.x >= 0 && I.x <= MAP_WIDTH &&
              I.y >= 0 && I.y <= MAP_HEIGHT;
          };
        
          I.sprite = Sprite("enemy");
        
          I.draw = function(cam) {
            this.sprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
          };
        
          I.update = function() {
            I.x += I.xVelocity;
            I.y += I.yVelocity;
        
            //I.xVelocity = 3 * Math.sin(I.age * Math.PI / 64);
        
            I.age++;
        
            I.active = I.active && I.inBounds();
          };
        
          I.explode = function() {
            Sound.play("explosion");
        
            this.active = false;
            // Extra Credit: Add an explosion graphic
          };
        
          return I;
        };
        

        setInterval(function() {
          update();
          draw();
        }, 1000/FPS);
		maps[0].loadDefaultTiles();
	//------------MAIN-----------------------------------------
        function update() {
		    if(modekey.check()) {
				if (Mode==0) {
					Mode=1;
					camera.center(edcursor);
				}else if (Mode==1) {
				    Mode=0;
					camera.center(player); 
				}else if (Mode==2) {
				    Mode=0;
				}
					
			 }
			  if(shiftkey.check()) { 
			  if (Mode==0) {  camera.center(player); }
			  if (Mode==1) {  camera.center(edcursor); }
			  }
			  //if(hkey.check()) {alert("NO HELP FOR YOU");}
		    if (true){ //camera mode
			 			
			  if(keydown.a) {
				camera.x -= 1;
				if (camera.x<0) {camera.x=0;}
			  }
			
			  if(keydown.d) {
				camera.x += 1;
				if (camera.x>(MAP_WIDTH-camera.width)) {camera.x=MAP_WIDTH-camera.width;}
			  }
			  
			  if(keydown.w) {
				camera.y -= 1;
				if (camera.y<0) {camera.y=0;}
			  }
			
			  if(keydown.s) {
				camera.y += 1;
				if (camera.y>(MAP_HEIGHT-camera.height)) {camera.y=MAP_HEIGHT-camera.height;}
			  }
			 

		  } if(Mode==1){ //edit mode
		      if (defkey.check()) {maps[0].loadDefaultTiles();}
			  if(keydown.space) {
				maps[0].setTile(edcursor.x,edcursor.y,edcursor.type);
			  }
			  if(savekey.check()) {
				maps[0].saveTiles("edsmap");
			  }
			  			  
			  if(loadkey.check()) {
				maps[0].loadTiles("edsmap");
			  }
			  
			  if(helpkey.check()){
			    alert("Arrow keys = move cursor, B = toggle speed, Space = Place block, V = Mouse mode toggle, N = switch block, Shift= Center Camera on cursor, M= switch to player mode, O = save map, L= loadmap");
			 }
			 
			 if (edcursor.mouse) {
				edcursor.x=Math.round(canX/16)+camera.x;
				edcursor.y=Math.round(canY/16)+camera.y;
				if(Mouse.mouseIsDown){
				  maps[0].setTile(edcursor.x,edcursor.y,edcursor.type)
				}
				if(Mouse.wasWheeled) {
					Mouse.wasWheeled=false;
					if(Mouse.mDelta>0) {
						edcursor.type++;
						if (edcursor.type > 9) {edcursor.type=0;}
					}else{
						edcursor.type--;
						if (edcursor.type <0) {edcursor.type=9;}
				    } 
				}
			}
			  
			  edcursor.getKeys();
		  }else if(Mode==0) {
			player.getKeys(maps[0]);
		     if(keydown.space) { 
				  player.shoot();
			  }
			  camera.center(player);
			  if(helpkey.check()){
			    alert("Arrow keys = move player, Space = shoot, M= switch to edit mode");
			 }
		  }
        
			  playerBullets.forEach(function(bullet) {
				bullet.update(maps[0]);
			  });
		  
		  handleCollisions();
          playerBullets = playerBullets.filter(function(bullet) {
            return bullet.active;
          });
          
          enemies.forEach(function(enemy) {
            enemy.update();
          });
        
          enemies = enemies.filter(function(enemy) {
            return enemy.active;
          });
        
          
        
          if((Math.random() < 0.1) && (enemies.length<5)) {
            //enemies.push(Enemy());
          }
        }
        
        player.shoot = function() {
          if (playerBullets.length>9) {return;}
		  //Sound.play("shoot");
        
          var bulletPosition = this.midpoint();
		  bulletPosition.x=this.x;
		  bulletPosition.y=this.y;
        
          playerBullets.push(Bullet({ 
            speed: 1,
			dir: this.dir,
            x: bulletPosition.x,
            y: bulletPosition.y
          }));
        };
        
        player.midpoint = function() {
          return {
            x: this.x + this.width/2,
            y: this.y + this.height/2
          };
        };
        
        function draw() {
          canvas.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

		  
		 maps.forEach(function(imap) {
            imap.draw(camera);
			imap.drawRadar(camera, 570, 466);
         });
		 
		 
		 
		 if(true) { player.draw(camera);}
		 if(true) { edcursor.draw(camera);}
          
          playerBullets.forEach(function(bullet) {
            bullet.draw(camera);
          });
        
          enemies.forEach(function(enemy) {
            enemy.draw(camera);
          });
        }
        
        function collides(a, b) {
          return a.x*16 < b.x + b.width &&
            a.x*16 + a.width > b.x &&
            a.y*16 < b.y + b.height &&
            a.y*16 + a.height > b.y;
        }
		
      
        function handleCollisions() {
          playerBullets.forEach(function(bullet) {
            enemies.forEach(function(enemy) {
              if(collides(bullet, enemy)) {
                enemy.explode();
                bullet.active = false;
              }
            });
          });
        
          enemies.forEach(function(enemy) {
            if(collides(enemy, player)) {
              enemy.explode();
              player.explode();
            }
          });
        }
        
        player.explode = function() {
          this.active = false;
          // Extra Credit: Add an explosion graphic and then end the game
        };
        
        player.sprite = Sprite("player");
        
        player.draw = function(cam) {
		  //canvas.globalCompositeOperation = 'source-in';
          this.sprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
		  //canvas.globalCompositeOperation = 'source-over';
        };
      //]]>
    </script>
  </body>
</html>
