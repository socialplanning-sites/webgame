<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>Go kill Smedly!!</title>
    <link href="/stylesheets/screen.css" media="all" rel="stylesheet" type="text/css"/>
    <script language="javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script><script language="javascript" src="javascripts/jquery.hotkeys.js" type="text/javascript"></script><script language="javascript" src="javascripts/key_status.js" type="text/javascript"></script><script language="javascript" src="javascripts/util.js" type="text/javascript"></script><script language="javascript" src="javascripts/sprite.js" type="text/javascript"></script><script language="javascript" src="javascripts/sound.js" type="text/javascript"></script>
  </head>
  <body>
	<audio id="myAudio" preload="auto">
    <source src="songu.mp3" type="audio/mpeg" />
	Your browser does not support the audio element.
   	</audio>
		
	<audio id="jump" preload="auto">
    <source src="sounds/jump.wav" type="audio/wav" />
    </audio>
		
	<audio id="explosion" preload="auto">
    <source src="sounds/explosion.wav" type="audio/wav" />
    </audio>
	   
	<audio id="shoot" preload="auto">
    <source src="sounds/shoot.wav" type="audio/wav" />
    </audio>
	
	<audio id="coin" preload="auto"">
    <source src="sounds/coin.wav" type="audio/wav" />
    </audio>
	
	<audio id="playerhurt" preload="auto">
    <source src="sounds/playerhurt.wav" type="audio/wav" />
    </audio>
	
	<audio id="Enemy_Hit" preload="auto">
    <source src="sounds/Enemy_Hit.wav" type="audio/wav" />
    </audio>
	
	<audio id="Enemy_Kill" preload="auto">
    <source src="sounds/Enemy_Kill.wav" type="audio/wav" />
    </audio>
	
	<audio id="Item" preload="auto">
    <source src="sounds/Item.wav" type="audio/wav" />
    </audio>
	
    <audio id="ItemFanfare" preload="auto">
    <source src="sounds/ItemFanfare.wav" type="audio/wav" />
    </audio>
	
	<audio id="Key" preload="auto">
    <source src="sounds/Key.wav" type="audio/wav" />
      </audio>
	
    <audio id="HeartContainer" preload="auto">
    <source src="sounds/HeartContainer.wav" type="audio/wav" />
    </audio>
	
	<audio id="dying" preload="auto">
    <source src="sounds/dying.wav" type="audio/wav" />
    </audio>
	
	<audio id="Sword4" preload="auto">
    <source src="sounds/Sword4.wav" type="audio/wav" />
    </audio>
	
	<audio id="Swim" preload="auto">
    <source src="sounds/Swim.wav" type="audio/wav" />
    </audio>
	
	<audio id="GrassWalk" preload="auto">
    <source src="sounds/GrassWalk.wav" type="audio/wav" />
    </audio>
	
	<audio id="unlock" preload="auto" >
    <source src="sounds/unlock.wav" type="audio/wav" />
    </audio>
	
	<audio id="locked" preload="auto">
    <source src="sounds/locked.wav" type="audio/wav" />
    </audio>
	
    <h1>Hit H for controls. </h1>

    <script type='text/javascript'>
      //<![CDATA[

$(document).bind("contextmenu",function(e){
	return false;
    }); 

var textPause=false;
var textText="";
var CANVAS_WIDTH = 900;
var CANVAS_HEIGHT = 640;
var MAP_WIDTH = 120;
var MAP_HEIGHT = 80;
var FPS = 30;
var LAVA_RATE=2000;
var WATER_RATE=1000;
var BURN_RATE=100;
var CHARANI_RATE= 200;
var FALL_DMG=900;
var SPAWN_X=22;
var SPAWN_Y=19;
var GRAVITY_RATE=5;
//var keychart = ["w","a","d","s","up","right","down","left","m","n","shift"];

var darkgrasssprite = Sprite("darkgrass"); //begin loading images.  Eventually I should put them all on one .png file
var grasssprite = Sprite("grass");
var watersprite = Sprite("water");
var chutelsprite = Sprite("parachutel");
var chutersprite = Sprite("parachuter");
var lavasprite=[];
lavasprite[0] = Sprite("lava");
lavasprite[1] = Sprite("lava1");
lavasprite[2] = Sprite("lava2");
lavasprite[3] = Sprite("lava3");
lavasprite[4] = Sprite("lava4");
var rocksprite = Sprite("stone2");
var stonebricksprite = Sprite("stonewall");
var bricksprite = Sprite("brick");
var dirtsprite = Sprite("dirt");
var woodsprite = Sprite("wood");
var crystalsprite = Sprite("crystalfloor");
var mudsprite = Sprite("mud");
var obsidiansprite = Sprite("obsidian");
var mossysprite = Sprite("mossy");
var stonesprite = Sprite("stone");
var reddoorsprite = Sprite("reddoor");
var greendoorsprite = Sprite("greendoor");
var bluedoorsprite = Sprite("bluedoor");
var yellowdoorsprite = Sprite("yellowdoor");
var purpledoorsprite = Sprite("purpledoor");
var lightbluedoorsprite = Sprite("lightbluedoor");
var claysprite = Sprite("clay");
var pedastalsprite = Sprite("pedastal");
var wtfsprite = Sprite("wtf");
var cobblesprite = Sprite("cobblestone");
var plankssprite = Sprite("woodplanks");
var edsprite = Sprite("cursor");
var shroomsprite = Sprite("shroom");
var heartsprite = Sprite("heart");
var halfheartsprite = Sprite("halfheart");
var redkeysprite= Sprite("redkey");
var greenkeysprite= Sprite("greenkey");
var bluekeysprite= Sprite("bluekey");
var yellowkeysprite= Sprite("yellowkey");
var purplekeysprite= Sprite("purplekey");
var lightbluekeysprite= Sprite("lightbluekey");
var goldsprite =Sprite("gold");
var bombsprite =Sprite("bomb");
var redbombsprite =Sprite("redbomb");
var shieldsprite =Sprite("bubble");
var crackedsprite =Sprite("cracked");
var platformsprite =Sprite("plat");
var icesprite =Sprite("frozen");
var decoysprite =Sprite("stuffedbear");
var launchersprite= Sprite("launcher");
var launcherlsprite= Sprite("launcherl");
var launcherrsprite= Sprite("launcherr");
var launcherusprite= Sprite("launcheru");
var launcherdsprite= Sprite("launcherd");
var fireshirtsprite= Sprite("redtunic");
var explosionsprite=new Array(4);
explosionsprite[0] =Sprite("explosion0");
explosionsprite[1] =Sprite("explosion1");
explosionsprite[2] =Sprite("explosion2");
explosionsprite[3] =Sprite("explosion3");

var SideMode=false;
var editHistory=[];
Mode = 0;
TopView=true;
var playerBullets = [];
var playerBombs = [];
var playerDecoys = [];
var explosions = [];
var edititems= [];

var NUM_TILES=58; //numer of tile types
var NUM_THINGS=30;
var FROZE_DUR=2000;
var JUMP_DUR=100;
var JUMP_BEFORE_DOUBLEJUMP_DUR=100;

var canvasElement = $("<canvas width='" + CANVAS_WIDTH + 
		      "' height='" + CANVAS_HEIGHT + "'></canvas");
var canvas = canvasElement.get(0).getContext("2d");
canvasElement.appendTo('body');
//todo:  find some way to put this in map or tile?
var tileani=0;
var anicount=0;
var anirate=1000;
var lastani=0;
var gotall=false;
var numsounds=0;
var soundsplaying ="";
var timestamp = new Date(); 
var milliseconds = timestamp.getTime();
var lasttime=0;

spawners= [];
enemies = [];

function playSound(name){
    
    nerp=document.getElementById(name);
    if(nerp.ended == true || nerp.currentTime == 0){
	nerp.play()
	    numsounds++;
    }
    
};

function akey(k) {  //represents a keyboard button
    k = k || "space";
    this.key =k;
    this.aflag=false;
	this.dflag=false;
    this.check= function(){
	if (keydown[this.key]) { 
	    this.aflag=true;
	    return false;
	}
	if((!keydown[this.key]) && (this.aflag==true)){
	    this.aflag=false;
	    return true;
	}
    };
	this.checkDown= function(){
	if ((keydown[this.key] )  && (!this.dflag)) { 
	    this.dflag=true;
	    return true;
	}
	if(!keydown[this.key]){
	    this.dflag=false;
	    return false;
	}
    };
    return this;
}

function aExplosion(I) {  //represents a keyboard button
    if( ! I.x ) {I.x=0;}
    if( ! I.y ) {I.y=0;}
    if( ! I.timedet ) {I.timedet=0;}
    if( ! I.duration ) {I.duration=5;}
    if( ! I.active ) {I.active=false;}
    I.ani=0;
    I.draw =function(cam) {
	explosionsprite[I.ani].draw(canvas, (I.x-cam.x)*16, (I.y-cam.y)*16);
    };
    I.update =function() {
	if(Mode==1) {return;}
	if((milliseconds-I.timedet>I.duration*1000) && (I.active)){
	    I.active=false;
	}
	I.ani++;
	if (I.ani>3) {I.ani=0;}
    };
    
    I.checkCollide= function(targ) { //did the player bump into another object
	tempx=I.x*16+16;
	tempy=I.y*16+16;
	if((tempx > targ.x*16) && (tempx <targ.x*16+targ.width) && (tempy > targ.y*16) && (tempy <targ.y*16+targ.height)) {
	    return true;
	}
	return false;
    }	;
    return I;
};

function aDecoy(I) {  //represents a keyboard button
    if( ! I.x ) {I.x=0;}
    if( ! I.y ) {I.y=0;}
	if( ! I.lastdroptime ) {I.lastdroptime=0;}
    if( ! I.width ) {I.width=64;}
    if( ! I.height ) {I.height=64;}
    if( ! I.timeplaced ) {I.timeplaced=0;}
    if( ! I.fuse ) {I.fuse=10;}
    if( ! I.active ) {I.active=false;}

    
    
    I.kill =function() {
	//particle smoke?
	I.active=false;
	};
	
    I.draw =function(cam) {
	
		decoysprite.draw(canvas, (I.x-cam.x)*16, (I.y-cam.y)*16);
    };
    
    I.update= function(merp){
		if(Mode==1) {return;}
	if((milliseconds-I.timeplaced>I.fuse*1000) ){
	    I.kill();	
	}
	
		if( SideMode )
		{ //gravity
			if( (!merp.canStand(this.x,this.y+2)) && 
				(!merp.canStand(this.x+1,this.y+2)) ) {
				this.y+=1;
			}
			this.lastdroptime=milliseconds;
		}
	
	
    };
    return I;
};

function aBomb(I) {  //represents a keyboard button
    if( ! I.x ) {I.x=0;}
    if( ! I.y ) {I.y=0;}
	if( ! I.xv ) {I.xv=0;}
	if( ! I.yv ) {I.yv=0;}
	if( ! I.lastdroptime ) {I.lastdroptime=0;}
    if( ! I.width ) {I.width=64;}
    if( ! I.height ) {I.height=64;}
    if( ! I.timeplaced ) {I.timeplaced=0;}
    if( ! I.fuse ) {I.fuse=4;}
    if( ! I.active ) {I.active=false;}
    if( ! I.armed ) {I.armed=false;}
	if( ! I.proxy ) {I.proxy=false;}
	if( ! I.gravity) {I.gravity=false;}
    if( ! I.flippers ) {I.flippers=false;}
	I.key=new Array(10);
	I.key[0]=false;
	I.key[1]=false;
	I.key[2]=false;
	I.key[3]=false;
	I.key[4]=false;
	I.key[5]=false;
    I.arm= function(x,y){
	I.timeplaced = milliseconds;
	I.armed=true;
    };
    
    
    
    I.explode =function() {
	//particle smoke?
	ptimeplaced = milliseconds;
	
	explosions.push(aExplosion({ 
		    duration: 1,
			x: this.x,
			y: this.y,
			width: 64,
			height: 64,
			timedet: ptimeplaced,
			active: true
			}));
	
	playSound("explosion");
	I.armed=false;
	I.active=false;
	
	
    };
    I.draw =function(cam) {
	if((milliseconds-I.timeplaced>I.fuse*800) && (I.armed)){
	    if(milliseconds%2==0){
		redbombsprite.draw(canvas, (I.x-cam.x)*16, (I.y-cam.y)*16);
	    }else{
		bombsprite.draw(canvas, (I.x-cam.x)*16, (I.y-cam.y)*16);
	    }
	}else
	    bombsprite.draw(canvas, (I.x-cam.x)*16, (I.y-cam.y)*16);
    };
    
    I.update= function(merp){
	if(Mode==1) {return;}
	if((milliseconds-I.timeplaced>I.fuse*1000) && (I.armed)){
	    I.active=false;
	    I.explode();
	}
		
	I.x+=I.xv;
	I.y+=I.yv;
	if((!merp.canWalk(this,this.x,this.y)) || (!merp.canWalk(this,this.x+1,this.y)) ||(!merp.canWalk(this,this.x,this.y+1))||(!merp.canWalk(this,this.x+1,this.y+1))) {this.explode();}

		if( (SideMode) && (I.gravity) )
		{ //gravity
			if( (!merp.canStand(this.x,this.y+2)) && 
				(!merp.canStand(this.x+1,this.y+2)) ) {
				this.y+=1;
			}
			this.lastdroptime=milliseconds;
		}
	
	
    };
    return I;
};

function textbox(msg) {  //draws a text box
    canvas.save();
    canvas.globalAlpha=0.80;
    canvas.fillStyle = "#DCDCDC";
    canvas.fillRect(30,400,840,210);
    
    canvas.fillStyle = "#483D8B ";
    canvas.fillRect(40,410,820,190);
    
    canvas.font = "16pt Calibri";
    canvas.textAlign = "left";
    canvas.textBaseline = "middle";
    canvas.fillStyle = "white";
    canvas.fillText(msg, 60,410+15);
    
    canvas.restore();
};
		
function drawmousetext(targ,cam) { //draws unit status info
    canvas.font = "14pt Calibri";
    canvas.textAlign = "center";
    canvas.textBaseline = "middle";
    canvas.fillStyle = "yellow";
    tempstr = targ.name+": "+targ.hp+ " / " +targ.maxhp;
    canvas.fillText(tempstr, (targ.x-cam.x)*16+(targ.width/2), (targ.y-cam.y)*16+targ.height+8);
    
    canvas.fillStyle = "#5F9EA0";
};

function aMouse() {  //represents the mouse
    this.mX= 0;
    this.mY= 0;
    this.lastY=0;
    this.lastX=0;
    this.tx= 0;
    this.ty= 0;
    this.mDelta=0;
    this.wasWheeled= false;
    this.mouseIsDown= false;
    this.mouseRightDown= false;
    this.lFlag=false;
    this.rFlag=false;
    
    
    mouseXY= function(e) {
	if (!e) var e = event;
	mX = e.pageX - canvasElement.get(0).offsetLeft;
	mY = e.pageY - canvasElement.get(0).offsetTop;
			
    };
    
    isOver= function(targ,cam){ //is the mouse over the player//object
	if((mX>(targ.x-cam.x)*16) && (mX<(targ.x-cam.x)*16+targ.width) &&(mY>(targ.y-cam.y)*16) &&(mY<(targ.y-cam.y)*16+targ.height)) {return true;}
	return false;
    };
    
    this.startStroke= function(e) { //mousewheel
	if (!e) var e = event;
	mDelta=e.wheelDelta;
	wasWheeled=true;
	
    };
    
    this.touchXY= function(e) { //touchsreen TODO: this
	if (!e) var e = event;
	e.preventDefault();
	mX = e.targetTouches[0].pageX - canvasElement.get(0).offsetLeft;
	mY = e.targetTouches[0].pageY - canvasElement.get(0).offsetTop;
	
    };
    
    mouseUp= function(e) {
	if (!e) var e = event;
	e.preventDefault();
	if(e.which==1){	mouseIsDown = 0;}
	if(e.which==3){	mouseRightDown = 0;}
	mouseXY(e);
    };
    
    touchUp= function() {
	mouseIsDown = 0;
	//do something.
    };
    
    mouseDown= function(e) {
	if (!e) var e = event;
	e.preventDefault();
	if (e.which==1){
	    mouseIsDown = 1;
	    mouseXY(e);
	    lastX=tx;
	    lastY=ty;
	    tx=Math.floor(this.mX/16);
	    ty=Math.floor(this.mY/16);
	}else {
	    mouseRightDown= true;
	    mouseXY(e);
	    tx=Math.floor(this.mX/16);
	    ty=Math.floor(this.mY/16);
	}
    };
    
    this.touchDown= function() {
	mouseIsDown = 1;
	//do something();
    };
    return this;
};

var Mouse= aMouse();

canvasElement.get(0).addEventListener("mousewheel",Mouse.startStroke,false);
canvasElement.get(0).addEventListener("mousemove", Mouse.mouseXY, false);
canvasElement.get(0).addEventListener("mousedown", Mouse.mouseDown, false);

canvasElement.get(0).addEventListener("touchstart", Mouse.touchDown, false);
canvasElement.get(0).addEventListener("touchmove", Mouse.touchXY, true);   //TODO: Implement touch screen functions
canvasElement.get(0).addEventListener("touchend", Mouse.touchUp, false);
 
document.body.addEventListener("mouseup", Mouse.mouseUp, false);
document.body.addEventListener("touchcancel", Mouse.touchUp, false);

var savekey=new akey("o"); //define the different keys
var loadkey=new akey("l");

var serversavekey=new akey("i");
var serverloadkey=new akey("k");

var upkey=new akey("w");
var leftkey=new akey("a");
var downkey=new akey("s");
var rightkey=new akey("d");
var aimupkey=new akey("i");
var aimleftkey=new akey("j");
var aimdownkey=new akey("k");
var aimrightkey=new akey("l");
var wkey=new akey("up");
var dkey=new akey("right");
var skey=new akey("down");
var aakey=new akey("left");
var modekey=new akey("m");
var nkey=new akey("n");
var shiftkey=new akey("shift");
var helpkey=new akey("h");
var slowkey=new akey("b");
var cmousekey=new akey("v");
var defkey=new akey("q");
var magickey=new akey("e");
var mgcyclekey=new akey("r");
var itemcyclekey=new akey("f");
var usekey=new akey("space");	
var undokey=new akey("z");		
var testkey=new akey("y");	
var jumpkey=new akey("w");	
var platkey=new akey("p");	
var delwallkey=new akey("r");	
var stuff=[];

function stringifySpawners(name){
    var tempobjs = [];
    for (i=0;i<spawners.length; i++){
	var tempobj = {'type': spawners[i].type, 
		       'x': spawners[i].x, 'y': spawners[i].y,
		       'spawnrate': spawners[i].spawnrate, 'maxspawns': spawners[i].maxspawns};
	tempobjs.push(tempobj);
    }
    var tempstring = JSON.stringify(tempobjs);
    return tempstring;
};

function stringifyStuff(name){
    var tempobjs = [];
    for (i=0;i<stuff.length; i++){
	var tempobj = {'type': stuff[i].type, 'x': stuff[i].x, 'y': stuff[i].y};
	tempobjs.push(tempobj);
    }
    var tempstring = JSON.stringify(tempobjs);
    return tempstring;
};

function saveStuff(name){
    var tempstring = stringifyStuff(name);
    localStorage.setItem(name, tempstring);
};

function saveSpawners(name){
    var tempstring = stringifySpawners(name);
    localStorage.setItem(name, tempstring);
};

function stringifyJunk(name){
    var tempstring = SPAWN_X + "," + SPAWN_Y + "," + Smedly.x + "," + Smedly.y + "," + Wizard.x + "," + Wizard.y + "," + SideMode;
    return tempstring;
};
			
function saveJunk(name){
    var tempstring = stringifyJunk();
    localStorage.setItem(name, tempstring);
};

function loadJunk(name){
    var tempstring = localStorage.getItem(name);
    tempstring=tempstring.split(",");
    SPAWN_X=parseInt(tempstring[0]);
    SPAWN_Y=parseInt(tempstring[1]);
    Smedly.x=parseInt(tempstring[2]);
    Smedly.y=parseInt(tempstring[3]);
    Wizard.x=parseInt(tempstring[4]);
    Wizard.y=parseInt(tempstring[5]);
    SideMode = (tempstring[6] == "true");
};
			
function buildMapFromJunk(tempstring){
    tempstring=tempstring.split(",");
    SPAWN_X=parseInt(tempstring[0]);
    SPAWN_Y=parseInt(tempstring[1]);
    Smedly.x=parseInt(tempstring[2]);
    Smedly.y=parseInt(tempstring[3]);
    Wizard.x=parseInt(tempstring[4]);
    Wizard.y=parseInt(tempstring[5]);
    SideMode = (tempstring[6] == "true");
	player.x=SPAWN_X;
	player.y=SPAWN_Y;
	camera.center(player);
};


function buildMapFromLoadedSpawners(name, tempstring) {
    spawners=[];
    var tempobjs = JSON.parse(tempstring);
    for( var i=0; i<tempobjs.length; i++ ) {
	var tempobj = tempobjs[i];
	ning=new EnemySpawner();
	ning.x=tempobj.x;
	ning.y=tempobj.y;
	ning.type=tempobj.type;
	ning.spawnrate=tempobj.spawnrate;
	spawners.push(ning);
    }
};

function loadSpawners(name) {
    var tempstring = localStorage.getItem(name);
    buildMapFromLoadedSpawners(name, tempstring);
};

function buildMapFromLoadedStuff(name, tempstring) {
    stuff=[];
    var tempobjs = JSON.parse(tempstring);
    for( var i=0; i<tempobjs.length; i++ ) {
	var tempobj = tempobjs[i];
	ning=new thing();
	ning.x=tempobj.x;
	ning.y=tempobj.y;
	ning.type=tempobj.type;
	ning.setSprite();
	stuff.push(ning);
    }
};

function loadStuff(name) {
    var tempstring = localStorage.getItem(name);
    buildMapFromLoadedStuff(name, tempstring);
};

var camera = {  //represents the camera, aka what part of the map is on screen
    x: 0,
    y: 0,
    width: 60,
    height: 40,
    center: function(targ) {
	tx=targ.x-26;
	ty=targ.y-20;
	if (tx<0) {tx=0;}
	if (ty<0) {ty=0;}
	if (tx>MAP_WIDTH-this.width) {tx=MAP_WIDTH-this.width;}
	if (ty>MAP_HEIGHT-this.height) {ty=MAP_HEIGHT-this.height;}
	
	this.x=tx;
	this.y=ty;
    },
    check: function() {
	this.x.clamp(0, MAP_WIDTH-60);
	this.y.clamp(0, MAP_HEIGHT-40);
    },
    rX: function(fx) {
	return fx-this.x;
    },
    rY: function(fy) {
	return fy-this.y;
    }
};

function thing(tipe,px,py,col) {  //represents collectable objects
    if(!col) {col=true;}
    this.x= px;
    this.y= py;
    this.xVelocity=0;
    this.yVelocity=0;
    this.type=tipe;
    this.active= true;
	this.flippers=true;
	this.lastdroptime= 0;
    this.width= 32;
    this.height= 32;
    this.name="Shroom";
	this.collectable= col;
	this.pushable=false;
    this.sprite= Sprite("shroom");
    if (this.type==1) {
	this.sprite= Sprite("heart");
	this.name="Heart Cointainer";
    }else if (this.type==2) {
	this.sprite= Sprite("gold");
	this.name="Gold Coin";
    }else if (this.type==3) {
	this.sprite= Sprite("silver");
	this.name="Silver Coin";
    }else if (this.type==4) {
	this.sprite= Sprite("copper");
	this.name="Copper Coin";
    }else if (this.type==5) {
	this.sprite= Sprite("manapotion");
	this.name="Mana Potion";
    }else if (this.type==6) {
	this.sprite= Sprite("manaup");
	this.name="Max Mana Up";
    }else if (this.type==7) {
	this.sprite= Sprite("redkey");
	this.name="Red Key";
    }else if (this.type==8) {
	this.sprite= Sprite("bluekey");
	this.name="Blue Key";
    }else if (this.type==9) {
	this.sprite= Sprite("greenkey");
	this.name="Green Key";
    }else if (this.type==10) {
	    this.sprite= Sprite("yellowkey");
	    this.name="Yellow Key";
	}else if (this.type==11) {
	    this.sprite= Sprite("purplekey");
	    this.name="Purple Key";
	}else if (this.type==12) {
	    this.sprite= Sprite("lightbluekey");
	    this.name="Light Blue Key";
	}else if (this.type==13) {
	this.sprite= Sprite("woodensword");
	this.name="Wooden Sword";
    }else if (this.type==14) {
	this.sprite= Sprite("stonesword");
	this.name="Stone Sword";
    }else if (this.type==15) {
	this.sprite= Sprite("ironsword");
	this.name="Iron Sword";
    }else if (this.type==16) {
	this.sprite= Sprite("flippers");
	this.name="Flippers";
    }else if (this.type==17) {
	this.sprite= Sprite("bomb");
	this.name="Bomb";
    }else if (this.type==18) {
	this.sprite= Sprite("hammer");
	this.name="Hammer";
    }else if (this.type==19) {
	this.sprite= Sprite("book");
	this.name="Book";
    }else if (this.type==20) {
	this.sprite= Sprite("boots");
	this.name="Speed Boots";
    }else if (this.type==21) {
	this.sprite= Sprite("rumham");
	this.name="RUM HAM";
    }else if (this.type==22) {
	this.sprite= Sprite("jumpboots");
	this.name="Doube-Jump Boots";
    }else if (this.type==23) {
	this.sprite= Sprite("feather");
	this.name="Fall Feather";
    }else if (this.type==24) {
	this.sprite= Sprite("launcher");
	this.name="Bomb Launcher";
    }else if (this.type==25) {
	this.sprite= Sprite("stuffedbear");
	this.name="Stuffed Bear";
    }else if (this.type==26) {
		this.sprite= Sprite("crate");
		this.name="Crate";
		this.collectable=false;
		this.pushable=true;
    }else if (this.type==27) {
	this.sprite= Sprite("parachutel");
	this.name="Parachute";
    }else if (this.type==28) {
	this.sprite= Sprite("shovel");
	this.name="Ed's Shovel";
    }else if (this.type==29) {
	this.sprite= Sprite("superbomb");
	this.name="Super Bombs";
    }else if (this.type==30) {
	this.sprite= Sprite("redtunic");
	this.name="Fire Shirt";
    }

    this.setSprite= function() {
	if (this.type==1) {
	    this.sprite= Sprite("heart");
	    this.name="Heart Cointainer";
	}else if (this.type==2) {
	    this.sprite= Sprite("gold");
	    this.name="Gold Coin";
	}else if (this.type==3) {
	    this.sprite= Sprite("silver");
	    this.name="Silver Coin";
	}else if (this.type==4) {
	    this.sprite= Sprite("copper");
	    this.name="Copper Coin";
	}else if (this.type==5) {
	    this.sprite= Sprite("manapotion");
	    this.name="Mana Potion";
	}else if (this.type==6) {
	    this.sprite= Sprite("manaup");
	    this.name="Max Mana Up";
	}else if (this.type==7) {
	    this.sprite= Sprite("redkey");
	    this.name="Red Key";
	}else if (this.type==8) {
	    this.sprite= Sprite("bluekey");
	    this.name="Blue Key";
	}else if (this.type==9) {
	    this.sprite= Sprite("greenkey");
	    this.name="Green Key";
	}else if (this.type==10) {
	    this.sprite= Sprite("yellowkey");
	    this.name="Yellow Key";
	}else if (this.type==11) {
	    this.sprite= Sprite("purplekey");
	    this.name="Purple Key";
	}else if (this.type==12) {
	    this.sprite= Sprite("lightbluekey");
	    this.name="Light Blue Key";
	}else if (this.type==13) {
	    this.sprite= Sprite("woodensword");
	    this.name="Wooden Sword";
	}else if (this.type==14) {
	    this.sprite= Sprite("stonesword");
	    this.name="Stone Sword";
	}else if (this.type==15) {
	    this.sprite= Sprite("ironsword");
	    this.name="Iron Sword";
	}else if (this.type==16) {
	    this.sprite= Sprite("flippers");
	    this.name="Flippers";
	}else if (this.type==17) {
	    this.sprite= Sprite("bomb");
	    this.name="Bomb";
	}else if (this.type==18) {
	    this.sprite= Sprite("hammer");
	    this.name="Hammer";
	}else if (this.type==19) {
	    this.sprite= Sprite("book");
	    this.name="Book";
	}else if (this.type==20) {
	    this.sprite= Sprite("boots");
	    this.name="Speed Boots";
	}else if (this.type==21) {
	    this.sprite= Sprite("rumham");
	    this.name="RUM HAM";
	}else if (this.type==22) {
		this.sprite= Sprite("jumpboots");
		this.name="Doube-Jump Boots";
    }else if (this.type==23) {
		this.sprite= Sprite("feather");
		this.name="Fall Feather";
    }else if (this.type==24) {
		this.sprite= Sprite("launcher");
		this.name="Bomb Launcher";
    }else if (this.type==25) {
		this.sprite= Sprite("stuffedbear");
		this.name="Stuffed Bear";
    }else if (this.type==26) {
		this.sprite= Sprite("crate");
		this.name="Crate";
		this.collectable=false;
		this.pushable=true;
    }else if (this.type==27) {
		this.sprite= Sprite("parachutel");
		this.name="Parachute";
    }else if (this.type==28) {
		this.sprite= Sprite("shovel");
		this.name="Ed's Shovel";
    }else if (this.type==29) {
	this.sprite= Sprite("superbomb");
	this.name="Super Bombs";
    }else if (this.type==30) {
	this.sprite= Sprite("redtunic");
	this.name="Fire Shirt";
    }
    };
    this.draw= function(cam) {
	this.sprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
    };
    this.colision= function(that) {
	if( ((this.x==that.x) ||(this.x==that.x+1))&& ((this.y==that.y) || (this.y==that.y+1)) ) {
	    this.active=false;
	    return true;
	}
	return false;
    };
    this.update=function(ply,merp) {
	if(Mode==1) {return;}
	if(this.colision(ply)) { //TODO: hold over head ala zelda?
	    if(this.collectable) {this.active=false;}
	    if (this.type==0) {ply.heal(10); playSound("Item");}  //mushroom heals
	    if (this.type==1) {
		ply.maxhp+=20; ply.hp=ply.maxhp; playSound("HeartContainer");
		textPause=true;
		ply.grabedsprite=this.sprite;
		textText="You found a Heart Container!  Your max health is increased by 20";
	    }  //heart container //sound!
	    if (this.type==2) {ply.pay(25); playSound("coin");} //gold
	    if (this.type==3) {ply.pay(10); playSound("coin");}  //silver
	    if (this.type==4) {ply.pay(1);  playSound("coin");} //copper
	    if (this.type==5) {ply.MP(15);  playSound("Item");} //mana potion
	    if (this.type==6) {
		ply.maxmp+=20; ply.mp=ply.maxmp; playSound("ItemFanfare");
		textPause=true;
		ply.grabedsprite=this.sprite;
		textText="You found a Mana Container!  Your max MP is increased by....some amount";
	    } //mana increase
	    if (this.type==7) {ply.key[0]=true;playSound("Key"); }  //redkey
	    if (this.type==8) {ply.key[1]=true; playSound("Key");} //blue key
	    if (this.type==9) {ply.key[2]=true; playSound("Key");} //green key
		if (this.type==10) {ply.key[3]=true;playSound("Key"); }  //yellowkey
	    if (this.type==11) {ply.key[4]=true; playSound("Key");} //purple key
	    if (this.type==12) {ply.key[5]=true; playSound("Key");} //light blue key
	    if (this.type==13) {
		ply.sword=woodsword; playSound("ItemFanfare");
		textPause=true;
		ply.grabedsprite=this.sprite;
		textText="You got the Wooden Sword!  It sorta blows.";
	    } //sword
	    if (this.type==14) {
		ply.sword=stonesword; playSound("ItemFanfare");
		textPause=true;
		ply.grabedsprite=this.sprite;
		textText="You got the Stone Sword.  It's an improvment!";
	    } //stone sword
	    if (this.type==15) {
		ply.sword=ironsword; playSound("ItemFanfare");
		textPause=true;
		ply.grabedsprite=this.sprite;
		textText="You found the Iron Sword!  Best. Sword. Ever.";
	    } //iron sword
	    if (this.type==16) {
		ply.flippers=true; playSound("ItemFanfare");
		textPause=true;
		ply.grabedsprite=this.sprite;
		textText="You found the Flippers! Now you can travel through water!";
	    } //flippers
	    if (this.type==17) { //bombs
		if(ply.hasbombs){
		    ply.bombs+=2; playSound("Item");
		}else {
		    ply.hasbombs=true; ply.bombs=10;  playSound("ItemFanfare");
		    textPause=true;
		    ply.grabedsprite=this.sprite;
		    textText="You found the Bombs!  But then I suppose I didn't hide them very well...";
		} 
		
	    } 
		if (this.type==29) { //super bombs
		if(ply.hassuperbombs){
		    ply.supbombs+=2; playSound("Item");
		}else {
		    ply.hassuperbombs=true; ply.supbombs=10;  playSound("ItemFanfare");
		    textPause=true;
		    ply.grabedsprite=this.sprite;
		    textText="You found the Super Bombs!  ...Super!";
		} 
		
	    } 
	    if (this.type==18) {
		ply.hammer=true; playSound("ItemFanfare");
		textPause=true;
		ply.grabedsprite=this.sprite;
		textText="You found the Hammer!  Too bad  I haven't coded it yet.";
	    } //hammer
	    if (this.type==19) {
		ply.book=true; playSound("ItemFanfare");
		textPause=true;
		ply.spells[0]=true;
		ply.spells[1]=true;
		ply.spells[2]=true;
		ply.grabedsprite=this.sprite;
		textText="You have learned a new spell from the Book!  Hit R to cycle through spells.";
	    } //book
	    if (this.type==20) {
		ply.dashboots=true; playSound("ItemFanfare");
		ply.speed=37;
		textPause=true;
		ply.grabedsprite=this.sprite;
		textText="You found the Speed Boots! Now you move faster!";
	    } //boots
	    if (this.type==21) {
		ply.rumham=true; playSound("ItemFanfare");
		textPause=true;
		ply.chute=true;
		ply.maxbombs=100;
		ply.maxhp=300;
		ply.maxmp=400;
		ply.hp=300;
		ply.mp=400;
		ply.hasbombs=true;
		ply.bombs=100;
		ply.sword=ironsword;
		ply.firetunic=true;
		ply.shovel=true;
		ply.hassuperbombs=true;
		ply.supbombs=10;
		ply.fallfeather=true;
		ply.haslauncher=true;
		ply.hasbears=true;
		ply.bears=3;
		ply.doublejumpboots=true;
		ply.dashboots=true;
		ply.speed=10;
		ply.flippers=true;
		ply.grabedsprite=this.sprite;
		ply.key[0]=true;
		ply.key[1]=true;
		ply.key[2]=true;
		ply.key[3]=true;
		ply.key[4]=true;
		ply.key[5]=true;
		textText="You found the Rum Ham!  Looks like you'll be getting HAMmered tonight!";
	    } //boots
		if (this.type==22) {
		ply.doublejumpboots=true; playSound("ItemFanfare");
		textPause=true;
		ply.grabedsprite=this.sprite;
		textText="You found the Double Jump Boots! Now you can double jump!";
	    } //double jump boots
		if (this.type==23) {
		ply.fallfeather=true; playSound("ItemFanfare");
		textPause=true;
		ply.grabedsprite=this.sprite;
		textText="You found the Fall Feather! now you don't take fall damage!";
	    } //fall feather
		if (this.type==25) { //stuffed bears
		if(ply.hasbears){
		    ply.bears+=1; playSound("Item");
		}else {
		    ply.hasbears=true; ply.bears=2;  playSound("ItemFanfare");
		    textPause=true;
		    ply.grabedsprite=this.sprite;
		    textText="You found a Stuffed Bear! It looks just like you!";
		} 
		
	    } 
		if (this.type==24) {
		ply.haslauncher=true; playSound("ItemFanfare");
		textPause=true;
		ply.grabedsprite=this.sprite;
		textText="You found the Launcher! Badass!";
	    } 
		if (this.type==26) {
			//crate!  push it?
			if (ply.dir==0){
				this.y-=1;
			}
			if (ply.dir==1){
				this.x+=1;
			}
			if (ply.dir==2){
				this.y+=1;
			}
			if (ply.dir==3){
				this.x-=1;
			}
	    } 
		if (this.type==27) {
		ply.chute=true; playSound("ItemFanfare");
		textPause=true;
		ply.grabedsprite=this.sprite;
		textText="You found the Parachute! Now you can move while falling!";
	    } 
		if (this.type==28) {
		ply.shovel=true; playSound("ItemFanfare");
		textPause=true;
		ply.grabedsprite=this.sprite;
		textText="You found Ed's Shovel!  You're not sure who Ed is but hey, free shovel!";
	    } 
		if (this.type==30) {
		ply.firetunic=true; playSound("ItemFanfare");
		textPause=true;
		ply.grabedsprite=this.sprite;
		textText="You found a Red Shirt!  Lets assume it's lava-proof!";
	    } 
	}
	
	if( SideMode )
	{ //gravity
	    if( (!merp.canStand(this.x,this.y+2)) && 
			(!merp.canStand(this.x+1,this.y+2)) ) {
			this.y+=1;
		 }
		this.lastdroptime=milliseconds;
	}
	
	
	this.x += this.xVelocity;
	this.y += this.yVelocity;
    };
    return this;
};



var bColors = ["#008000","#006400", "#FF4500", "#000080", "#696969", "#800080", "#808000", "#A52A2A", "#8B4513", "#FFDEAD", "#FFFF40","#000080" , "#FFFF80"]; //list of colors for radar/a few other things

function makeNewTile() { //the Map is made of a 2D array of tiles.
    var tile = {
	width: 16,
	height: 16,
	x: 0,
	y: 0,
	cracked: 0,
	platform: 0,
        fluidVacuum: false,
	ani:0,
	color: "#FFC020",
	data: 0,
	draw: function(cam) { 
	    if(this.data==0){
		grasssprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.data==1){
		stonesprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.data==2){
		mudsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.data==3){
		crystalsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16); 
	    }else if(this.data==4){
		mossysprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.data==5){
		stonebricksprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.data==6){
		plankssprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.data==7){
		cobblesprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.data==8){
		dirtsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.data==9){
		claysprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.data==10){
		wtfsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.data==11){
		pedastalsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.data==45){ //walls
		reddoorsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.data==46){
		bluedoorsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.data==47){
		greendoorsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.data==48){ 
		yellowdoorsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.data==49){
		purpledoorsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.data==50){
		lightbluedoorsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.data==44){
		darkgrasssprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.data==43){
		lavasprite[tileani].draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.data==42){
		watersprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.data==58){
		obsidiansprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.data==56){
		bricksprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.data==57){
		woodsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else{  //if strange data, draw a solid color
		canvas.fillStyle = bColors[0]; 
		canvas.fillRect((this.x-cam.x)*this.width, (this.y-cam.y)*this.height, this.width, this.height);
	    }
	    if(this.cracked==1){
		crackedsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }
		if(this.platform==1){
		platformsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }
            
	}
    };
    
    return tile;
};

var Wizard = {  //an NPC
    name: "Wizard",
    color: "#00A",
    x: 11,
    y: 13,
    dir: 0,
    maxhp:100,
    hp:100,
    mp:400,
    gothurt: 0,
    maxmp:400,
    type: 0,
    hp: 100,
    width: 32,
    active: true,
    height: 32,
    angle: 0,
    sprite: Sprite("wizard"),
    draw: function(cam) {
	if (this.gothurt>0) {
	    this.gothurt--;
	    canvas.save();
	    if(this.gothurt%2==0){canvas.globalAlpha = 0.75;}
	    this.sprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    canvas.restore();
	}else
	    {
		this.sprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }
	
    },
    
    
};

var Smedly = { //the first boss, currently has no AI
    name: "Smedly",
    color: "#00A",
    x: 6,
    y: 53,
    dir: 0,
    maxhp:100,
    hp:100,
    mp:40,
    contactDmg: 25,
    gothurt: 0,
    maxmp:40,
    type: 0,
    hp: 100,
    width: 140,
    active: true,
    height: 140,
    angle: 0,
    sprite: Sprite("smedly"),
    draw: function(cam) {
	if (this.gothurt>0) {
	    this.gothurt--;
	    canvas.save();
	    if(this.gothurt%2==0){canvas.globalAlpha = 0.75;}
	    this.sprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    canvas.restore();
	}else
	    {
		this.sprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }
	if(Mouse.isOver(this,cam)) {drawmousetext(this,cam);}
    },
    
    hurt: function(dmg) {
	if(this.gothurt>0) {return;}
	
	this.hp-=dmg;
	if (this.hp<1) {this.explode();}
	//TODO:knockback?
	playSound("Enemy_Hit");
	this.gothurt=5;
    },
    
    update: function(merp) {
	//todo: Smedly AI
	if(Mode==1) {return;}
	if( SideMode )
	{ //gravity
		if( (!merp.canStand(this.x,this.y+10)) && 
			(!merp.canStand(this.x+1,this.y+10)) ) {
				this.y+=1;
			}
			this.lastdroptime=milliseconds;
		}
	
	
    },
    
    explode: function() {
	playSound("Enemy_Kill");
	this.active = false;
	// TODO: Add an explosion graphic
    },
    
    checkCollide: function(targ) { //did the player bump into another object
	tempx=this.x*16+16;
	tempy=this.y*16+16;
	if((tempx > targ.x*16) && (tempx <targ.x*16+targ.width) && (tempy > targ.y*16) && (tempy <targ.y*16+targ.height)) {
	    return true;
	}
	return false;
    }	
    
};

var woodsword= { //the first sword
    len: 12,
    width: 4,
    speed: 3,
    track: 0,
    color: "#663300",
    count: 0,
    dmg: 10,
    active: false,
    going: true
};

var stonesword= { //the first sword
    len: 17,
    width: 4,
    speed: 6,
    track: 0,
    color: "#999966",
    count: 0,
    dmg: 15,
    active: false,
    going: true
};

var ironsword= { //the first sword
    len: 20,
    width: 6,
    speed: 9,
    track: 0,
    color: "#CCFFFF",
    count: 0,
    dmg: 20,
    active: false,
    going: true
};

var nosword= { //the first sword
    len: 0,
    width: 4,
    speed: 2,
    track: 0,
    color: "#00A",
    count: 0,
    dmg: 10,
    active: false,
    going: true
};
var player = {  //the bear.
    name: "Bear",
    color: "#00A",
    x: 22,
    y: 19,
	aim:0,
	haslauncher: false,
	bears: 0,
	shovel: false,
	firetunic: false,
	hasbears: false,
    jumping: false,
	falling: false,
	jumpfalling:false,
	fallfeather: false,
    doublejumping: false,
	hassuperbombs: true,
	supbombs: 10,
    doublejumpboots: false,
	chute: false,
    dir: 2,
    selected: false,
    maxhp:100,
    spells: 0,
    hp:50,
    mp:20,
    curspell: 0,
	curitem: 0,
    maxmp:20,
    type: 0,
    hasbombs: false,
    hammer: false,
    book: false,
    boots: false,
    bombs:0,
    flippers: false,
    magicShield: false,
    width: 32,
    height: 32,
    ani: 0,
    cash: 0,
    frozen: false,
    frozetime: 0,
    maxcash: 200,
    kills: 0,
    gothurt: 0,
    key: Array(10),
    grabsprite: 0,
    grabedsprite: 0,
    sword: 0,
    timelastmoved: 0,
    lastani: 0,
    lastdroptime: 0,
	lastburn: 0,
    speed: 70,
    init: function () {  //load sprites
	this.sword=nosword;
	this.spells=new Array(8);
	this.spells[0]=false;  //fireball
	this.spells[1]=false;  //magic shield
	this.spells[2]=false;  //jump
	this.spells[3]=false;  //encircle
	this.spells[4]=false;  //heal
	this.spells[5]=false;  //push
	this.sprites=new Array(4); //4 directions
	this.sprites[0] = new Array(2);  //2 frames
	this.sprites[1] = new Array(2);
	this.sprites[2] = new Array(2);
	this.sprites[3] = new Array(2);
	this.grabsprite= Sprite("beargrab");
	this.sprites[0][0]= Sprite("bearback1");
	this.sprites[0][1]= Sprite("bearback2");
	
	this.sprites[1][0]= Sprite("bearr1");
	this.sprites[1][1]= Sprite("bearr2");
	
	this.sprites[2][0]= Sprite("bear1");
	this.sprites[2][1]= Sprite("bear2");
	
	this.sprites[3][0]= Sprite("bearl1");
	this.sprites[3][1]= Sprite("bearl2");
	for(p=0;p<this.key.length;p++){this.key[p]=false;}
    },
    
    MP: function(dmg) { //affect MP
	this.mp+=dmg;
	if(this.mp>this.maxmp) {this.mp=this.maxmp;}
	if(this.mp<0) {this.mp=0;};
    },
    
    checkCollide: function(targ) { //did the player bump into another object
	tempx=this.x*16+16;
	tempy=this.y*16+16;
	if((tempx > targ.x*16) && (tempx <targ.x*16+targ.width) && (tempy > targ.y*16) && (tempy <targ.y*16+targ.height)) {
	    return true;
	}
	return false;
    },			 
    
    drawmp: function(){  //really draws most of the H.U.D.
	
	canvas.font = "14pt Calibri";
	canvas.textAlign = "left";
	canvas.textBaseline = "middle";
	canvas.fillStyle = "white";
	canvas.fillText("MP:", 68, 48);
	canvas.fillText("Bombs:", 43, 64);
	canvas.fillText(this.bombs, 105, 64);
	
	canvas.fillText(SideMode,105, 120);	
	canvas.fillText("DbJump?",60, 140);	
	canvas.fillText(player.doublejumping,145, 140);	
	
	canvas.fillText("falling?",60, 160);	
	canvas.fillText(player.jumpfalling,145, 160);	
	
	
	canvas.fillStyle = "#5F9EA0";
	canvas.fillRect(100, 40, this.mp, 16);
	
	//todo:MOVE THIS
	if(this.key[0]){
	    redkeysprite.draw(canvas,7,20);
	}
	if(this.key[1]){
	    bluekeysprite.draw(canvas,25,20);
	}
	if(this.key[2]){
	    greenkeysprite.draw(canvas,7,40);
	}
	if(this.key[3]){
	    yellowkeysprite.draw(canvas,25,40);
	}
	if(this.key[4]){
	    purplekeysprite.draw(canvas,7,60);
	}
	if(this.key[5]){
	    lightbluekeysprite.draw(canvas,25,60);
	}
	
	goldsprite.draw(canvas,655,25);
	canvas.font = "14pt Calibri";
	canvas.textAlign = "left";
	canvas.textBaseline = "middle";
	canvas.fillStyle = "white";
	if(player.cash==player.maxcash) {canvas.fillStyle = "blue";}
	canvas.fillText(":" + player.cash, 670, 32);
	canvas.fillText("Item:", 700, 32);
	if((player.curitem==0) && (player.hasbombs))
	{
		bombsprite.draw(canvas,734,24);
	}else if((player.curitem==1) &&(player.hasbears))
	{
		decoysprite.draw(canvas,734,24);
	}else if((player.curitem==2) && (player.haslauncher))
	{
		launchersprite.draw(canvas,734,24);
	}else if((player.curitem==4) && (player.chute))
	{
		chutersprite.draw(canvas,734,24);
	}
    },
    
    drawHearts: function() {
	
	canvas.font = "14pt Calibri";
	canvas.textAlign = "center";
	canvas.textBaseline = "middle";
	canvas.fillStyle = "white";
	canvas.fillText("Health:", 70, 25);
	conts=this.hp/20;
	for(h=0;h<conts-1;h++)
	    {
		heartsprite.draw(canvas,100+h*16+h*2, 20);
	    }
	if(this.hp%20==0)
	    {
		heartsprite.draw(canvas,100+h*16+h*2, 20);
	    }else{
	    halfheartsprite.draw(canvas,100+h*16+h*2, 20);
	}
    },
    
    hurt: function(dmg) {
	if(this.gothurt>0) {return;}
	
	if(this.magicShield){
	    if (this.mp>14){
		this.MP(-15);
		//todo: sound!
		return;
	    } else {
		this.magicShield=false;
	    }
	}
	this.hp-=dmg;
	if (this.hp<1) {this.kill()}
	//TODO:knockback?
	playSound("playerhurt");
	this.gothurt=5;
    },
    
    heal: function(dmg) {
	this.hp+=dmg;
	if (this.hp>this.maxhp) {this.hp=this.maxhp;}
	//graphic?
	//Sound.play("healing");
    },
    
    pay: function(amt) {
	this.cash+=amt;
	if (this.cash>this.maxcash) {this.cash=this.maxcash;}
	//graphic?
	//Sound.play("coin");
    },
    freeze: function() {
	this.frozen=true;
	this.frozetime=milliseconds;
    },
    
    
    hitsword: function (px,py,pw,ph){//sword collision detection
	if(!this.sword.active) {return false;} //todo: change this to check rectangle not just end point.
	if(this.dir==0){
	    tempx=(this.x)*16+16;
	    tempy=(this.y)*16-this.sword.track*2;
	    if((tempx > px*16) && (tempx < px*16+pw)){
		if((tempy >py*16) && (tempy< py*16+ph)){
		    return true;
		}
	    }
	    
	}else if(this.dir==1){
	    tempx=(this.x)*16+32+this.sword.track*2;;
	    tempy=(this.y)*16+16
	    if((tempx > px*16) && (tempx < px*16+pw)){
		if((tempy >py*16) && (tempy< py*16+ph)){
		    return true;
		}
	    }
	}else if(this.dir==2){
	    tempx=(this.x)*16+16;
	    tempy=(this.y)*16+32+this.sword.track*2;
	    if((tempx > px*16) && (tempx < px*16+pw)){
		if((tempy >py*16) && (tempy< py*16+ph)){
		    return true;
		}
	    }
	}else if(this.dir==3){
	    tempx=(this.x)*16-this.sword.track*2;;
	    tempy=(this.y)*16+16
	    if((tempx > px*16) && (tempx < px*16+pw)){
		if((tempy >py*16) && (tempy< py*16+ph)){
		    return true;
		}
	    }
	}
	return false;
    },
    
    
    drawsword: function(cam){
	
	canvas.fillStyle = this.sword.color;
	if(this.dir==0){
	    
	    canvas.fillRect((this.x-cam.x)*16+16, (this.y-cam.y)*16, this.sword.width, -this.sword.track*2);
	}else if(this.dir==1){
	    canvas.fillRect((this.x-cam.x)*16+32, (this.y-cam.y)*16+16, this.sword.track*2,this.sword.width);
	}else if(this.dir==2){
	    canvas.fillRect((this.x-cam.x)*16+16, (this.y-cam.y)*16+32, this.sword.width, this.sword.track*2);
	}else if(this.dir==3){
	    canvas.fillRect((this.x-cam.x)*16, (this.y-cam.y)*16+16, -this.sword.track*2,this.sword.width);
	}
	
    },
    
    animate: function() { //TODO: make this time based, SLOWER
	
	if (milliseconds-this.lastani>CHARANI_RATE) {
	    this.lastani=milliseconds;
	    if(this.ani==0){
		this.ani=1;
	    }else{
		this.ani=0;
	    }
	}
    },
    
    
    update: function() {
	if(Mode==1) {return;}
	if(this.hp<1) {this.kill();}
	if(this.sword.active){
	    if(this.sword.going) {
		this.sword.track+=this.sword.speed;
	    }
	    
	    if(!this.sword.going) {
		this.sword.track-=this.sword.speed;
	    }
	    
	    if (this.sword.track>this.sword.len) { 
		this.sword.going=false;
		this.sword.track=this.sword.len;
	    }
	    
	    if (this.sword.track<1) { 
		this.sword.going=true
		this.sword.track=0;
		this.sword.active=false;
	    }

	    
	}
	
		if (milliseconds-this.lastburn>BURN_RATE) {
			this.lastburn=milliseconds;
			if ((!this.firetunic) &&(this.tiletype==43)) {this.hurt(20);} //lava
		}
	
	if( SideMode ) { //gravity
		var tar=0;
		if((this.chute) && (this.curitem==4)) {tar=70;}
		if((this.tiletype==42) || (this.tiletype==43)) {tar=100;}
	    if( milliseconds-this.lastdroptime>GRAVITY_RATE+tar ) {
		if(( this.jumping ) || (this.doublejumping)) {
		    if( (maps[0].canWalk(this, [this.x], [this.y-1])) && 
			(maps[0].canWalk(this, [this.x+1], [this.y-1])) ) {
			
			this.y-=1;

			this.falling=null;
			this.jumpfalling=null;
		    }
		    if( milliseconds-this.jumping>JUMP_DUR ) {this.jumping = null; this.jumpfalling=milliseconds; this.falling=milliseconds};//end !doublejumping.
		    if((this.doublejumping)  && (milliseconds-this.doublejumping>JUMP_DUR )) {this.doublejumping = null; this.jumpfalling=milliseconds;}//-JUM_DUR;}
		} else {
		    if( milliseconds-this.jumpfalling>JUMP_DUR ) {this.jumpfalling=null;} //
			if( (!maps[0].canStand(this.x,this.y+2)) && 
			(!maps[0].canStand(this.x+1,this.y+2)) ) {
			if(!this.falling){
				this.falling=milliseconds;
			}
			this.y+=1;
			camera.center(this);
			}else { 
				if((this.falling) && (milliseconds-this.falling>FALL_DMG) && (!this.fallfeather)){
					this.hurt(10);
				}
				this.falling=null;
				this.doublejumped=false;
			}
		}
		this.lastdroptime=milliseconds;
	    }
	}
	
	if((this.frozen) && (milliseconds-this.frozetime>FROZE_DUR)){ this.frozen=false; }
	
		this.tiletype=maps[0].walls[this.x][this.y].data;
	
    },
    
    kill: function() {
	
	//TODO: death animation, game over
	this.kills=0;
	this.x=SPAWN_X;
	this.y=SPAWN_Y;
	this.hp=100;
	this.gothurt=25;
	playSound("dying");
	
    },
    
    draw: function(cam) { //placeholder function
	canvas.fillStyle = bColors[this.type];
	canvas.fillRect((this.x-cam.x)*16, (this.y-cam.y)*16, this.width, this.height);
	if(this.magicShield){
	    
	}
    },
    
    move: function (px,py,merp) {///placeholder
	this.tiletype=merp.walls[this.x][this.y].data;
	var slowed=0;
	if(this.tiletype==44) {slowed=30;}
	if(milliseconds-this.timelastmoved<this.speed+slowed){ return; }
	if (this.tiletype==42) {playSound("Swim");}
	if (this.tiletype==44) {playSound("GrassWalk");}
	if (this.tiletype==20) {this.hurt(3);} //poison ground

	this.x+=px;
	this.y+=py
	this.timelastmoved=milliseconds;
	//camear.center(this);
	this.animate();
	
    },
    
    
    getKeys: function(merp,cam) {
	
	if(defkey.check()){
	    if ((!this.sword.active) && (this.sword!=nosword)){
		this.sword.active=true;
		playSound("Sword4");
	    }
	}
	
	if(mgcyclekey.check()){
	    this.curspell++;
	    
	    if(this.curspell>2){ 
		this.curspell=0;
	    }
	}
	
		
	if(itemcyclekey.check()){  //better way to do this?
	    if(this.curitem==0){ 
			if(this.hasbears)
			{
				this.curitem=1;
			}else if (this.haslauncher)
			{
				this.curitem=2
			}else if (this.chute)
			{
				this.curitem=4
			}
	    }else if(this.curitem==1){ 
			if(this.haslauncher)
			{
				this.curitem=2;
			}else if (this.chute)
			{
				this.curitem=4
			}else if (this.hasbombs)
			{
				this.curitem=0
			}
	    }else if(this.curitem==2){ 
			
			if (this.chute)
			{
				this.curitem=4
			}else if(this.hasbombs)
			{
				this.curitem=0;
			}else if (this.hasbears)
			{
				this.curitem=1
			}
	    }else if(this.curitem==4){ 
			
			if(this.hasbombs)
			{
				this.curitem=0;
			}else if (this.hasbears)
			{
				this.curitem=1
			}else if (this.haslauncher)
			{
				this.curitem=2
			}
	    }
	}
	
	if(magickey.check()){
	    if(this.spells[this.curspell]){
		if(this.curspell==0) {this.shoot();}
		if(this.curspell==1) {this.trishoot();}
		if((this.curspell==2) && (this.mp >14)) {this.magicShield=!this.magicShield;}
	    }
	}
	
	if(usekey.check()){
		if(this.curitem==0){ //bombs
			if(this.hasbombs){
			this.placeBomb();
			}
		}else if(this.curitem==1){ //decoy
			if(this.hasbears){
			this.placeDecoy();
			}
		}else if(this.curitem==2){ //launcher
			if((this.hasbombs) && (this.haslauncher)){
			this.launchBomb();
			}
		}
	}
	
	if(jumpkey.checkDown()) {
		if( SideMode ) {
		    if( (maps[0].canStand(this.x,this.y+2)) 
			|| (maps[0].canStand(this.x+1,this.y+2)) && (!this.jumping) ) {
			this.jumping = milliseconds;
			playSound("jump");
			
		    } else if (((this.jumping)|| (this.falling)) && (!this.doublejumped) &&(!this.doublejumping) && (this.doublejumpboots) && (milliseconds-this.jumping>JUMP_BEFORE_DOUBLEJUMP_DUR) ) {
			this.doublejumping=milliseconds;
			this.falling=null; //
			this.jumpfalling=null;
			this.doublejumped=true;
			playSound("jump");
		    }
		} 
	}
	if(SideMode){
	if(aimupkey.check()){
		this.aim=-1;
	}
	if(aimdownkey.check()){
		this.aim=+1;
	}
	if(aimleftkey.check()){
		this.aim=0;
	}
	if(aimrightkey.check()){
		this.aim=0;
	}
	}

	if(keydown.w) {
	    
	    if ((this.y>0) && (this.x<MAP_WIDTH-1)
		&& (merp.canWalk(this,[this.x],[this.y-1]))
		&& (merp.canWalk(this,[this.x+1],[this.y-1])) ) {
			if(!SideMode) {this.dir=0; this.move(0,-1,merp);} 
	    }
	} 
	if(keydown.a) {
	    this.dir=3;
		var movefall=(((!this.chute)||(this.curitem!=4))&& (this.falling) && (!this.jumping) && (!this.doublejumping) &&(!this.jumpfalling));
	    if ((!movefall)&&(this.x>0) && (this.y<MAP_HEIGHT-1) && (merp.canWalk(this,[this.x-1],[this.y])) && (merp.canWalk(this,[this.x-1],[this.y+1]))) {this.move(-1,0,merp);}
	}if(keydown.d) {
	    this.dir=1;
		movefall=(((!this.chute)||(this.curitem!=4)) && (this.falling) && (!this.jumping) && (!this.doublejumping)&&(!this.jumpfalling));
	    if ( (!movefall)&&(this.y<MAP_HEIGHT-1) && (this.x<MAP_WIDTH-2) &&(merp.canWalk(this,[this.x+2],[this.y])) && (merp.canWalk(this,[this.x+2],[this.y+1]))) {this.move(1,0,merp);}
	}if(keydown.s) {

			this.dir=2;
	if ((this.y<MAP_HEIGHT-2) && (this.x<MAP_WIDTH-1) && (merp.canWalk(this,[this.x],[this.y+2])) && (merp.canWalk(this,[this.x+1],[this.y+2]))) {this.move(0,1,merp);}
	}
	
	if((!SideMode) &&(keydown.i)){
		this.dir=0;
	}
	if(keydown.l){
		this.dir=1;
	}if((!SideMode) &&(keydown.k)){
		this.dir=2;
	}
	if(keydown.j){
		this.dir=3;
	}
	
	this.x = this.x.clamp(0, MAP_WIDTH-1);
	this.y = this.y.clamp(0, MAP_HEIGHT-1);
    }   
		

    
};

var edcursor = { //edit cursor
    color: "#00A",
    x: 1,
    y: 1,
	swapto: 0,
	swapfrom: 0,
    slow: false,
    mouse: true,
    lastx:0,
    selected: false,
	swpselected: false,
    lasty:0,
    cornerd: false,
    size: 1, //TODO: add for loops to draw, placement to make larger brush size, center it?
    type: 1,
    thingtrack:0,
    mode: 0,
    width: 16,
    height: 16,
    draw: function(cam) {
		if(this.type==0){
		grasssprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.type==1){
		stonesprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.type==2){
		mudsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.type==3){
		crystalsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16); //todo: duplicate! add new type
	    }else if(this.type==4){
		mossysprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.type==5){
		stonebricksprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.type==6){
		plankssprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.type==7){
		cobblesprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16); //todo: duplicate! add new type
	    }else if(this.type==8){
		dirtsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.type==9){
		claysprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.type==10){
		wtfsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.type==11){
		pedastalsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.type==45){
		reddoorsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.type==46){
		bluedoorsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.type==47){
		greendoorsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.type==48){ 
		yellowdoorsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.type==49){
		purpledoorsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.type==50){
		lightbluedoorsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.type==44){
		darkgrasssprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.type==43){
		lavasprite[tileani].draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.type==42){
		watersprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.type==58){
		obsidiansprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.type==56){
		bricksprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else if(this.type==57){
		woodsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }else{
	    canvas.fillStyle = bColors[this.type]; 
	    canvas.fillRect((this.x-cam.x)*this.width, (this.y-cam.y)*this.height, this.width, this.height);
	}
	edsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
    },
    
    getKeys: function() {
	if((this.type>11) && (this.type<41)) {this.type=41;} //todo remove!
	if(this.type>58) {this.type=0;}
	if(this.type<0) {this.type=58;}
	if(nkey.check()) { 
	    
	    if(this.mode==0){
		this.type++;
		if (this.type > NUM_TILES) {this.type=0;}
	    }else if(this.mode==1){
		//this.npctype++;?
	    }else if (this.mode==2) {
		this.thingtrack++
		if (this.thingtrack > NUM_THINGS-1) {this.thingtrack=0;}
	    }
	    
	}
	
	if(undokey.check()){
	    undoEdit();
	}
	
	if(slowkey.check()) {
	    this.mode++;
	    if (this.mode>6) {this.mode=0;} //NUM EDIT MODES
	}
	
	if(cmousekey.check()) {
	    this.mouse=!this.mouse;
	}
	
	if(platkey.check()) {
		if(maps[0].tiles[edcursor.x][edcursor.y].platform==0) {
			maps[0].tiles[edcursor.x][edcursor.y].platform=1;
		}else {
			maps[0].tiles[edcursor.x][edcursor.y].platform=0;
		}
	}
	
	if(delwallkey.check()) {
		
			maps[0].setWall(edcursor.x,edcursor.y,0);
	}
	
	
	
	if (this.slow) {
	    if(leftkey.check()) {
		this.x -= 1;
	    }
	    
	    if(rightkey.check()) {
		this.x += 1;
	    }
	    
	    if(upkey.check()) {
		this.y -= 1;
	    }
	    
	    if(downkey.check()) {
		this.y += 1;
	    }
	    
	}else{
	    
	    if(keydown.a) {
		this.x -= 1;
	    }
	    
	    if(keydown.d) {
		this.x += 1;
	    }
	    
	    if(keydown.w) {
		this.y -= 1;
	    }
	    
	    if(keydown.s) {
		this.y += 1;
	    }
	}
	this.x = this.x.clamp(0, MAP_WIDTH-1);
	this.y = this.y.clamp(0, MAP_HEIGHT-1);
    }
};

function Map(I) { //map object
    I = I || {};
    var i = 0;
    var j = 0;
    I.active = true;
    I.color = "#00A";
    I.tiles = new Array(MAP_WIDTH);
	I.walls = new Array(MAP_WIDTH);
    for( i=0; i<MAP_WIDTH; i++ ) { I.tiles[i] = new Array(MAP_HEIGHT); I.walls[i] = new Array(MAP_HEIGHT); }
    for (i=0;i<MAP_WIDTH; i++){
	for (j=0;j<MAP_HEIGHT; j++){
	    I.tiles[i][j]= makeNewTile();
	    I.tiles[i][j].x=i;
	    I.tiles[i][j].y=j;
	    I.walls[i][j]= makeNewTile();
	    I.walls[i][j].x=i;
	    I.walls[i][j].y=j;
	}
    }
    I.width = MAP_WIDTH;
    I.height = MAP_HEIGHT;

    I.update = function() {
	  if(Mode==1) {return;}
      if( SideMode ) {
        this.updateFluids();
      }
    };

    I.pullFluids = function(x, y, x1, y1) {
      var x2, y2;
    
      x2 = x; y2 = y - 1;
      if( x2 != x1 || y2 != y1 ) {
        if( I.walls[x2] && I.walls[x2][y2] && I.walls[x2][y2].data ) {
          if( parseInt(I.walls[x2][y2].data) == 42 ) {
            I.walls[x2][y2].nextFluidPull = ["y", 1];
          }
        }
      }
      x2 = x; y2 = y + 1;
      if( x2 != x1 || y2 != y1 ) {
        if( I.walls[x2] && I.walls[x2][y2] && I.walls[x2][y2].data ) {
          if( parseInt(I.walls[x2][y2].data) == 42 ) {
            I.walls[x2][y2].nextFluidPull = ["y", -1];
          }
        }
      }
      var xDir = parseInt(Math.random()*100) % 2 ? 1 : -1;
      x2 = x + xDir; y2 = y;
      if( x2 != x1 || y2 != y1 ) {
        if( I.walls[x2] && I.walls[x2][y2] && I.walls[x2][y2].data ) {
          if( parseInt(I.walls[x2][y2].data) == 42 ) {
            I.walls[x2][y2].nextFluidPull = ["x", -1*xDir];
          }
        }        
      }
      x2 = x - xDir; y2 = y;
      if( x2 != x1 || y2 != y1 ) {
        if( I.walls[x2] && I.walls[x2][y2] && I.walls[x2][y2].data ) {
          if( parseInt(I.walls[x2][y2].data) == 42 ) {
            I.walls[x2][y2].nextFluidPull = ["x", xDir];
          }
        }        
      }
    };

    I.pushFluid = function(x, y, direction, valence) {
      var x1, y1;
      if( direction == "x" ) {
        x1 = x + valence; y1 = y;
      } else {
        x1 = x; y1 = y + valence;
      }
    
      var x2, y2;

      var xDir = parseInt(Math.random()*100) % 2 ? 1 : -1;

      x2 = x + xDir; y2 = y;
      if( x2 != x1 || y2 != y1 ) {
        if( I.walls[x2] && I.walls[x2][y2] && I.walls[x2][y2].data ) {
          if( parseInt(I.walls[x2][y2].data) == 0 ) {
            I.moveFluid(x, y, "x", xDir);
            return;
          }
        }        
      }
      x2 = x -xDir; y2 = y;
      if( x2 != x1 || y2 != y1 ) {
        if( I.walls[x2] && I.walls[x2][y2] && I.walls[x2][y2].data ) {
          if( parseInt(I.walls[x2][y2].data) == 0 ) {
            I.moveFluid(x, y, "x", -1 * xDir);
            return;
          }
        }        
      }
      x2 = x; y2 = y - 1;
      if( x2 != x1 || y2 != y1 ) {
        if( I.walls[x2] && I.walls[x2][y2] && I.walls[x2][y2].data ) {
          if( parseInt(I.walls[x2][y2].data) == 0 ) {
            I.moveFluid(x, y, "y", -1);
            return;
          }
        }
      }

      x2 = x - 1; y2 = y;
      if( x2 != x1 || y2 != y1 ) {
        if( I.walls[x2] && I.walls[x2][y2] && I.walls[x2][y2].data ) {
          if( parseInt(I.walls[x2][y2].data) == 42 ) {
            I.walls[x2][y2].nextFluidPush = ["x", 1];
            return;
          }
        }        
      }
      x2 = x; y2 = y + 1;
      if( x2 != x1 || y2 != y1 ) {
        if( I.walls[x2] && I.walls[x2][y2] && I.walls[x2][y2].data ) {
          if( parseInt(I.walls[x2][y2].data) == 42 ) {
            I.walls[x2][y2].nextFluidPush = ["y", -1];
            return;
          }
        }
      }
    };
    I.moveFluid = function(x, y, direction, valence) {
      var x1, y1;
      if( direction == "x" ) {
        x1 = x + valence; y1 = y;
      } else {
        x1 = x; y1 = y + valence;
      }

      if( !I.walls[x1] || !I.walls[x1][y1] || !I.walls[x1][y1].data ) {
        return;
      }
      if( I.walls[x][y].processedFluid ) return;
      if( parseInt(I.walls[x1][y1].data) != 0 ) return; 

      I.pullFluids(x, y, x1, y1);
      I.setWall(x, y, I.walls[x1][y1].data);
      I.setWall(x1, y1, "0");
      I.walls[x][y].processedFluid = true;
    };
    
    I.updateFluids = function() {
        var fluidwalls =[];
        for( var i=0; i<MAP_WIDTH; ++i ) {
          for( var j=0; j<MAP_HEIGHT; ++j ) {
            if( parseInt(I.walls[i][j].data) != 42 ) continue; 
            fluidwalls.push([i,j, I.walls[i][j].data]);

            I.walls[i][j].processedFluid = null;

            I.walls[i][j].fluidPull = I.walls[i][j].nextFluidPull;
            I.walls[i][j].nextFluidPull = null;

            I.walls[i][j].fluidPush = I.walls[i][j].nextFluidPush;
            I.walls[i][j].nextFluidPush = null;
          }
        }
        I.fluidwalls = fluidwalls;

        var funcs = [I.updateFluidsFall, I.updateFluidsPush, I.updateFluidsPull];
        var i = Math.floor(Math.random()*3);
        funcs.splice(i, 1)[0](fluidwalls);

        var i = Math.floor(Math.random()*2)
        funcs.splice(i, 1)[0](fluidwalls);

        var i = Math.floor(Math.random()*1);
        funcs.splice(i, 1)[0](fluidwalls);
    };

    I.updateFluidsFall = function(fluidwalls) {
        for( var i=0; i<fluidwalls.length; ++i ) {
          var tileData = fluidwalls[i];

          if( !I.canStand(tileData[0], tileData[1]+1) ) {
            I.moveFluid(tileData[0], tileData[1], "y", 1);
          } else if( !I.canStand(tileData[0]-1, tileData[1]+1) ) {
            I.moveFluid(tileData[0], tileData[1], "x", -1);
          } else if( !I.canStand(tileData[0]+1, tileData[1]+1) ) {
            I.moveFluid(tileData[0], tileData[1], "x", 1);
          } else {
            if( I.walls[tileData[0]] &&
                I.walls[tileData[0]][tileData[1]+1] &&
                I.walls[tileData[0]][tileData[1]+1].data &&
                parseInt( I.walls[tileData[0]][tileData[1]+1].data ) == 42 ) {
              I.walls[tileData[0]][tileData[1]+1].nextFluidPush = ["y", -1];
            }
          }
        }
    }

    I.updateFluidsPull = function(fluidwalls) {
        for( var i=0; i<fluidwalls.length; ++i ) {
          var tileData = fluidwalls[i];
          var pullForce = I.walls[tileData[0]][tileData[1]].fluidPull;
          if( !pullForce ) {
            continue;
          }
          I.walls[tileData[0]][tileData[1]].fluidPull = null;
          I.moveFluid(tileData[0], tileData[1], pullForce[0], pullForce[1]);
        }
    }

    I.updateFluidsPush = function(fluidwalls) {
        for( var i=0; i<fluidwalls.length; ++i ) {
          var tileData = fluidwalls[i];
          var pushForce = I.walls[tileData[0]][tileData[1]].fluidPush;
          if( !pushForce ) {
            continue;
          }
          I.walls[tileData[0]][tileData[1]].fluidPush = null;
          I.pushFluid(tileData[0], tileData[1], pushForce[0], pushForce[1]);
        }

    };

    I.draw = function(cam) {
	cam.check();
	for (i=cam.x;i<cam.x+cam.width; i++){
	    for (j=cam.y;j<cam.y+cam.height; j++){
		if(I.tiles[i][j].data<41) {
			I.tiles[i][j].draw(cam);
		}
		if(I.walls[i][j].data>40){
			I.walls[i][j].draw(cam);
		}
	    }
	}
    };
    I.clear =function(){
	stuff=[];
	spawners=[];
	enemies=[];
	for (i=0;i<MAP_WIDTH; i++){
	    for (j=0;j<MAP_HEIGHT; j++){
		I.tiles[i][j]= makeNewTile();
		I.tiles[i][j].x=i;
		I.tiles[i][j].y=j;
		I.walls[i][j]= makeNewTile();
		I.walls[i][j].x=i;
		I.walls[i][j].y=j;
	    }
	}
    };
    I.stringifyTiles = function(name) {
	var tempstring= "";
	for (i=0;i<MAP_WIDTH; i++){
	    for (j=0;j<MAP_HEIGHT; j++){
		tempstring = tempstring +I.tiles[i][j].data;
		tempstring += ","
		    }
	}
	return tempstring;
    };
	
	I.stringifyWalls = function(name) {
	var tempstring= "";
	for (i=0;i<MAP_WIDTH; i++){
	    for (j=0;j<MAP_HEIGHT; j++){
		tempstring = tempstring +I.walls[i][j].data;
		tempstring += ","
		    }
	}
	return tempstring;
    };
    
    I.saveTiles = function (name) {
	var tempstring = I.stringifyTiles(name);
	localStorage.setItem(name, tempstring);
	
    };
	
	I.saveWalls = function (name) {
	var tempstring = I.stringifyWalls(name);
	localStorage.setItem(name, tempstring);
	
    };
	
	I.stringifyPlatforms = function (name) {
	var tempstring= "";
	for (i=0;i<MAP_WIDTH; i++){
	    for (j=0;j<MAP_HEIGHT; j++){
		tempstring = tempstring +I.tiles[i][j].platform;
		tempstring += ","
		    }
	}
	return tempstring;
    };
    
    I.stringifyCracked = function (name) {
	var tempstring= "";
	for (i=0;i<MAP_WIDTH; i++){
	    for (j=0;j<MAP_HEIGHT; j++){
		tempstring = tempstring +I.walls[i][j].cracked;
		tempstring += ","
		    }
	}
	return tempstring;
    };
    
    I.saveCracked = function (name) {
	var tempstring = I.stringifyCracked(name);
	localStorage.setItem(name, tempstring);
	
    };
	
	I.savePlatforms = function (name) {
	var tempstring = I.stringifyPlatforms(name);
	localStorage.setItem(name, tempstring);
	
    };
    
    I.buildMapFromLoadedTiles = function(name, hempstring) {
	tempstring=hempstring.split(",");
	for (i=0;i<MAP_WIDTH; i++){
	    for (j=0;j<MAP_HEIGHT; j++){
		I.tiles[i][j].data = tempstring[j+MAP_HEIGHT*i];
	    }
	}
    };
	
	I.buildMapFromLoadedWalls = function(name, hempstring) {
	tempstring=hempstring.split(",");
	for (i=0;i<MAP_WIDTH; i++){
	    for (j=0;j<MAP_HEIGHT; j++){
		I.walls[i][j].data = tempstring[j+MAP_HEIGHT*i];
	    }
	}
    };
    
    I.loadTiles = function (name) {
	var hempstring=localStorage.getItem(name);
	I.buildMapFromLoadedTiles(name, hempstring);
    };
	
	I.loadWalls = function (name) {
	var hempstring=localStorage.getItem(name);
	I.buildMapFromLoadedWalls(name, hempstring);
    };
    
    I.loadCracked = function (name) {
	var hempstring=localStorage.getItem(name);
	I.buildMapFromLoadedCracks(name, hempstring);
    };
    I.buildMapFromLoadedCracks = function(name, hempstring) {
	tempstring=hempstring.split(",");
	for (i=0;i<MAP_WIDTH; i++){
	    for (j=0;j<MAP_HEIGHT; j++){
		I.walls[i][j].cracked = tempstring[j+MAP_HEIGHT*i];
	    }
	}
    };
	
	I.loadPlatforms = function (name) {
		var hempstring=localStorage.getItem(name);
		I.buildMapFromLoadedPlatforms(name, hempstring);
    };
	
    I.buildMapFromLoadedPlatforms = function(name, hempstring) {
	tempstring=hempstring.split(",");
	for (i=0;i<MAP_WIDTH; i++){
	    for (j=0;j<MAP_HEIGHT; j++){
		I.tiles[i][j].platform = parseInt(tempstring[j+MAP_HEIGHT*i]);
	    }
	}
    };

    I.loadMapFromServer = function(url,ply) {
	    maps[0].clear();
	    var callback = function(data) {
		var obj = data;
		var tiles = obj.tiles;
		var walls = obj.walls;
		var cracked = obj.cracked;
		var platforms = obj.platforms;
		var stuff = obj.stuff;
		var junk = obj.junk;
		var spawners =obj.spawners;
window.loadedMap = obj;
		maps[0].buildMapFromLoadedTiles('', tiles);
		maps[0].buildMapFromLoadedWalls('', walls);
		maps[0].buildMapFromLoadedCracks('', cracked);
		maps[0].buildMapFromLoadedPlatforms('', platforms);
		buildMapFromLoadedStuff('', stuff);
		buildMapFromLoadedSpawners('', spawners);
		buildMapFromJunk( junk);
	    }


	    $.getJSON("http://server.webgame.zebra-associates.org/"+url+"?callback=?", callback);
    };
	
    I.setTile = function (x,y,data) {
	I.tiles[x][y].data = data;
    };
	
	I.setWall = function (x,y,data) {
	I.walls[x][y].data = data;
    };
    
    I.canWalk = function (ply,x,y) { //overhead + side mode
	if((x<0) || (y<0) || (y>MAP_HEIGHT-1) || (x>MAP_WIDTH-1)) {return false;}
	if ((I.walls[x][y].data >44)  && (I.walls[x][y].data <56) ){ //doors
		if (ply.key[I.walls[x][y].data-45]) {
		    playSound("unlock");
		    return true;
		}else {
		    playSound("locked");
		    return false;
		}
		
	}else if ((I.walls[x][y].data ==42)  && (ply.flippers)) { //water
	    return true;
	}else if ((I.walls[x][y].data ==43)  && (ply.firetunic)) { //lava
	    return true;
	}else if (I.walls[x][y].data <41) { //no wall
	    return true;
	}else if (I.walls[x][y].data ==44) { return true;} //bushes
	return false;
	
    };
    
    
    I.canShoot = function (x,y) { //overhead + side mode
		if (I.walls[x][y].data<45) {return true;}
    };
    
    
    I.canStand = function (x,y) { //sidemode only
        if( !I.walls[x] || !I.walls[x][y] ) {
          return true;
        }
	if (I.walls[x][y].data >44)   {
	    return true;
	}else if (I.tiles[x][y].platform){
		return true;
	}else {return false;}
    };
    
    
    I.drawRadar= function (cam,x,y,px,py) {
	cam.check();
	canvas.save();
	canvas.globalAlpha = 0.75;
	for (i=0;i<MAP_WIDTH; i++){
	    for (j=0;j<MAP_HEIGHT; j++){
		if(I.walls[i][j].data<41){
			canvas.fillStyle = bColors[I.tiles[i][j].data];
			canvas.fillRect(x+i*2, y+j*2, 2, 2);
		}else{
			canvas.fillStyle = bColors[I.walls[i][j].data];
			canvas.fillRect(x+i*2, y+j*2, 2, 2);
		}
	    }
	}
	canvas.fillStyle = "#FFD700";
	canvas.fillRect(x+px*2, y+py*2, 4, 4);
	canvas.restore();
    };
    return I;
}

maps = [];
maps.push(Map());

if( window.location.hash && window.location.hash.match("#map=") ) {
    var url = window.location.hash.substr(5);
    maps[0].loadMapFromServer(url);    
} else {
    var url = "miles";
    maps[0].loadMapFromServer(url);    
} 

for(ijk=0;ijk<NUM_THINGS+1;ijk++) //fills edititems with all types of thigns
    {
	edititems.push(new thing(ijk,0,0));
	
    }

for(ijk=0;ijk<32;ijk++) //randomly place 32 mushrooms
    {
	tempx=Math.floor(Math.random() *(MAP_WIDTH-2));
	tempy=Math.floor(Math.random() *(MAP_HEIGHT-2));
	if(maps[0].tiles[tempx][tempy].data==0) {
	    stuff.push(new thing(0,tempx,tempy));
	}
    }


function Bullet(I) {  //player fired projectile
    I.active = true;
    I.wavy=false;
    I.age = Math.floor(Math.random() * 128);
    var turb=3;//2 * Math.sin(I.age * Math.PI / 64);
    if(I.dir==0){
	I.xVelocity = 0;
	I.yVelocity = -I.speed;
	if(I.wavy) {
	    I.yVelocity=-turb;
	}
    }else if(I.dir==1){
	I.xVelocity = +I.speed;
	I.yVelocity = 0;
	if(I.wavy) {
	    I.xVelocity=turb;
	}
    }else if(I.dir==2){
	I.xVelocity = 0;
	I.yVelocity = +I.speed;
	if(I.wavy) {
	    I.yVelocity=turb;
	}
    }else if(I.dir==3){
	I.xVelocity = -I.speed;
	I.yVelocity = 0;
	if(I.wavy) {
	    I.xVelocity=-turb;
	}
    }
    I.width = 3;
    I.height = 3;
    I.dir = 1;
    I.color = "#AFEEEE";
    
    I.inBounds = function() {
	return I.x >= 0 && I.x <= MAP_WIDTH &&
	I.y >= 0 && I.y <= MAP_HEIGHT;
    };
    
    I.draw = function(cam) {
	canvas.fillStyle = this.color;
	canvas.fillRect((this.x-cam.x)*16, (this.y-cam.y)*16, this.width, this.height);
    };
    
    I.update = function(merp) {
	if(Mode==1) {return;}
	if(I.wavy) {
	    I.xVelocity=2 * Math.sin(I.age * Math.PI / 64)/4;
	}
	I.x += I.xVelocity;
	I.y += I.yVelocity;
	
	I.active = I.active && I.inBounds();
	if((I.x>MAP_WIDTH-1) || (I.y>MAP_HEIGHT-1) || (I.x<0) || (I.y<0)) {
	    I.active=false;
	}else if(!merp.canShoot([I.x],[I.y])) {I.active=false; } //todo:play a ding sound, change to merp.canflyover?
	
    };
    
    I.explode = function() {
	this.active = false;
	// TODO: graphic
    };
    
    I.checkHit= function(targ) {
	tempx=I.x*16;
	tempy=I.y*16;
	if((tempx+32	> targ.x*16) && (tempx <targ.x*16+targ.width) && (tempy+32 > targ.y*16) && (tempy <targ.y*16+targ.height)) {
	    I.active=false;
	    return true;
	    
	}
	return false;
    };
    
    
    return I;
}

		
function EnemySpawner(I) {  //todo: add more enemy types.
    I = I || {};
    I.name= "Mob Spawner";
    if(!I.type) {I.type="Chaser";}
    if(!I.hp) {I.hp=10;}
    if(!I.maxhp) {I.maxhp=10;}
    I.contactDmg=5;
    I.timelastspawned=0;
    I.speed=80;
    I.width=32;
    I.height=32;
    I.tiletype=0;
    I.numspawned=0;
    if(!I.spawnlimit) {I.spawnlimit=5;}
    I.ani=0;
    I.lastani=0;
    I.gothurt=0;
    I.active = true;
    I.spawnrate=10;
    I.sprite=new Array(2);
    I.sprite[0]= Sprite("warp1");
    I.sprite[1]= Sprite("warp2");
    
    if(!I.x) {I.x = 15;}
    if(!I.y) {I.y = 15;}
    I.spawnMob= function(){
	var thaser=new Enemy();
	thaser.name=I.type;
	thaser.x=I.x;
	thaser.y=I.y;
	thaser.enemyInit();
	enemies.push(thaser);
	I.numspawned++;
    };
    
    I.animate= function() { 
	if (milliseconds-this.lastani>CHARANI_RATE) {
		I.lastani=milliseconds;
		if(I.ani==0){
			I.ani=1;
		}else{
			I.ani=0;
		}
	}
    };
    
    I.hurt= function(dmg) {
	if(I.gothurt>0) {return;}
	I.hp-=dmg;
	if (I.hp<1) {I.kill();}
	I.gothurt=5;
	playSound("Enemy_Hit");
    };
    
    I.checkCollide= function(targ) { //did the player bump into another object
	tempx=I.x*16+16;
	tempy=I.y*16+16;
	if((tempx > targ.x*16) && (tempx <targ.x*16+targ.width) && (tempy > targ.y*16) && (tempy <targ.y*16+targ.height)) {
	    return true;
	}
	return false;
    };	
    
    I.spawnerInit = function(){
	
	if(this.type=="Evil Bunny"){
	    
	}
    };
    
    I.draw = function(cam) {
	if (I.gothurt>0) {
	    I.gothurt--;
	    canvas.save();
	    if(I.gothurt%2==0){canvas.globalAlpha = 0.5;}
	    this.sprite[this.ani].draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    canvas.restore();
	}else
	    {
		this.sprite[this.ani].draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }
	if(Mouse.isOver(I,cam)) {drawmousetext(I,cam);}
    };
    
    I.update = function() {
	if(Mode==1) {return;}
	if(I.numspawned<I.spawnlimit){
	    if(milliseconds-I.timelastspawned>I.spawnrate*1000)
		{
		    I.spawnMob();
		    I.timelastspawned=milliseconds;
		}
		I.animate();
	}
    };
    
    I.kill = function() {
	playSound("Enemy_Kill");
	blip = Math.random() *100;
	
	if (blip >70) {
	    stuff.push(new thing(5,Math.round(I.x),Math.round(I.y)));
	}else if (blip >40) {
	    stuff.push(new thing(3,Math.round(I.x),Math.round(I.y)));
	}else {	stuff.push(new thing(4,Math.round(I.x),Math.round(I.y)));}
	this.active = false;
	// todo: graphic
    };
    return I;
};

function Enemy(I) {  //todo: add more enemy types.
    I = I || {};
    I.name="Evil Bunny";
    I.hp=10;
    I.maxhp=10;
    I.contactDmg=5;
    I.timelastmoved=0;
	I.lastdroptime=0;
	I.grav=false;
    I.speed=80;
    I.slowed=0;
    I.tiletype=0;
    I.flippers=true;
    I.key=[];
    I.ani=0;
    I.lastani=0;
    I.def=1;
    I.gothurt=0;
    I.active = true;
    I.age = Math.floor(Math.random() * 128);
    
    I.color = "#A2B";
    
    I.x = Math.floor(Math.random() * MAP_WIDTH);
    I.y = 5;
    I.xVelocity = 0;
    I.yVelocity = 1;
    
    I.width = 32;
    I.height = 32;
    I.sprite=new Array(2);
    
    I.animate= function() { 
	if (milliseconds-this.lastani>CHARANI_RATE) {
	    I.lastani=milliseconds;
	    if(I.ani==0){
		I.ani=1;
	    }else{
		I.ani=0;
	    }
	}
    };
    
    
    I.move=function (px,py,merp) {
	if(this.frozen) {return;}
	var slowed=0;
	if(this.tiletype==3) {slowed=30;}
	if(milliseconds-this.timelastmoved<this.speed+slowed){ return; }
	if(px<0){
	    if ((this.x>0) && (this.y<MAP_HEIGHT-1) && (merp.canWalk(this,[this.x-1],[this.y])) && (merp.canWalk(this,[this.x-1],[this.y+1]))) {
		this.x+=px;
		this.tiletype=merp.walls[this.x][this.y].data;
		this.timelastmoved=milliseconds;
	    }
	}else if(px>0) {
	    if ((this.y<MAP_HEIGHT-1) && (this.x<MAP_WIDTH-2) &&(merp.canWalk(this,[this.x+2],[this.y])) && (merp.canWalk(this,[this.x+2],[this.y+1]))) {
		this.x+=px;
		this.tiletype=merp.walls[this.x][this.y].data;
		this.timelastmoved=milliseconds;
	    }
	}else if(py<0) {
	    if ((this.y>0) && (this.x<MAP_WIDTH-1) && (merp.canWalk(this,[this.x],[this.y-1])) && (merp.canWalk(this,[this.x+1],[this.y-1]))) {
		this.y+=py;
		this.tiletype=merp.walls[this.x][this.y].data;
		this.timelastmoved=milliseconds;
	    }
	}else if(py>0) {
	    if ((this.y<MAP_HEIGHT-2) && (this.x<MAP_WIDTH-1) && (merp.canWalk(this,[this.x],[this.y+2])) && (merp.canWalk(this,[this.x+1],[this.y+2]))) {
		this.y+=py;
		this.tiletype=merp.walls[this.x][this.y].data;
		this.timelastmoved=milliseconds;
	    }
	}
	
	I.animate();
	
    };
		  
    I.hurt= function(dmg) {
	if(I.gothurt>0) {return;}
	I.hp-=dmg;
	if (I.hp<1) {I.explode();}
	I.gothurt=5;
	playSound("Enemy_Hit");
    };
    
    I.inBounds = function() {
	return I.x >= 0 && I.x <= MAP_WIDTH &&
	I.y >= 0 && I.y <= MAP_HEIGHT;
    };
    
    I.checkCollide= function(targ) { //did the player bump into another object
	tempx=this.x*16+16;
	tempy=this.y*16+16;
	if((tempx > targ.x*16) && (tempx <targ.x*16+targ.width) && (tempy > targ.y*16) && (tempy <targ.y*16+targ.height)) {
	    return true;
	}
	return false;
    };	
    
    I.enemyInit = function(){
	I.key[0]=true;
	I.key[1]=true;
	I.key[2]=true;
	if(this.name=="Evil Bunny"){
	    I.sprite[0] = Sprite("enemy1");
	    I.sprite[1] = Sprite("enemy1");
	    I.hp=10;
	    I.contactDmg=5;
	    I.maxhp=10;
	}else if(this.name=="Chaser"){
	    I.sprite[0] = Sprite("chaser");
	    I.sprite[1] = Sprite("chaser2");
	    I.hp=40;
	    I.contactDmg=10;
	    I.speed=200;
	    I.maxhp=40;
		I.grav=true;
	}else if(this.name=="Hunter"){
	    I.sprite[0] = Sprite("hunter1");
	    I.sprite[1] = Sprite("hunter2");
	    I.hp=80;
	    I.contactDmg=25;
	    I.speed=100;
	    I.maxhp=80;
		I.grav=true;
	}
    };
    
    I.enemyInit();
    
    I.draw = function(cam) {
	if (I.gothurt>0) {
	    I.gothurt--;
	    canvas.save();
	    if(I.gothurt%2==0){canvas.globalAlpha = 0.5;}
	    this.sprite[this.ani].draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    canvas.restore();
	}else
	    {
		this.sprite[this.ani].draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	    }
	if(Mouse.isOver(I,cam)) {drawmousetext(I,cam);}
    };
    
    I.update = function(merp) {
	if(Mode==1) {return;}
	if( SideMode )
		{ //gravity
			if( (!merp.canStand(this.x,this.y+2)) && 
				(!merp.canStand(this.x+1,this.y+2)) ) {
				this.y+=1;
			}
			this.lastdroptime=milliseconds;
		}
	
	if(this.name=="Evil Bunny"){
	    I.x += I.xVelocity/4;
	    I.y += I.yVelocity/4;
	    
	    I.xVelocity = 3 * Math.sin(I.age * Math.PI / 64);
	}else if((this.name=="Chaser") || (this.name=="Hunter")){
		if(playerDecoys.length<1){
	    if(player.x>I.x) {I.move(1,0,maps[0]);}
	    if(player.x<I.x) {I.move(-1,0,maps[0]);}
	    if(player.y>I.y) {I.move(0,1,maps[0]);}
	    if(player.y<I.y) {I.move(0,-1,maps[0]);}
		}else
		{
			layer=playerDecoys[0];
			if(layer.x>I.x) {I.move(1,0,maps[0]);}
			if(layer.x<I.x) {I.move(-1,0,maps[0]);}
			if(layer.y>I.y) {I.move(0,1,maps[0]);}
			if(layer.y<I.y) {I.move(0,-1,maps[0]);}
		}
	}
	I.age++;
        
	I.active = I.active && I.inBounds();
    };
    
    I.explode = function() {
	playSound("Enemy_Kill");
	blip = Math.random() *100;
	if ((this.name=="Chaser") || (this.name=="Hunter")){
	    stuff.push(new thing(1,Math.round(I.x),Math.round(I.y)));
	}else if (blip >70) {
	    stuff.push(new thing(5,Math.round(I.x),Math.round(I.y)));
	}else if (blip >40) {
	    stuff.push(new thing(3,Math.round(I.x),Math.round(I.y)));
	}else {	stuff.push(new thing(4,Math.round(I.x),Math.round(I.y)));}
	this.active = false;
	// todo: graphic
	player.kills++;
    };
    
    return I;
};
        

setInterval(function() {
	update();
	draw();
    }, 1000/FPS);


		
document.getElementById("myAudio").addEventListener('ended', function() { //loops music
	this.currentTime = 0;
	this.play();
    }, false);

document.getElementById("myAudio").play(); //starts music

player.init();
//addEdit(maps[0]);


//spawners.push(new EnemySpawner({x:36,y:50,type: "Chaser",spawnrate:20}));
//spawners.push(new EnemySpawner({x:30,y:3,type: "Evil Bunny",spawnrate:10}));

/*chaser=new Enemy();
  chaser.name="Hunter";
  chaser.x=88;
  chaser.y=16;
  chaser.enemyInit();
  enemies.push(chaser);*/

//------------MAIN LOOP-----------------------------------------
function update() {
    lasttime=milliseconds;
    timestamp = new Date();
    milliseconds = timestamp.getTime();
    
    if(testkey.check()) {
	SideMode=!SideMode;
	if(!SideMode) {player.falling=null; player.jumping=null; player.doublejumping=null;}
    }
    
    if (milliseconds-lastani>LAVA_RATE) {
	tileani++;
	lastani=milliseconds;
	anicount=0;
    }
    if (tileani>3) {tileani=0} //tile animations
    if(textPause) {
	if(usekey.check()) {textPause=false;}
	return;
    };
    if(modekey.check()) {
	if (Mode==0) {
	    Mode=1;
	    camera.center(edcursor);
	}else if (Mode==1) {
	    Mode=0;
	    camera.center(player); 
	}else if (Mode==2) {
	    Mode=0;
	}
	
    }
    if(shiftkey.check()) { 
	if (Mode==0) {  camera.center(player); }
	if (Mode==1) {  camera.center(player); }
    }
    
    //camera controlls
    if(keydown.left) {
	camera.x -= 1;
	if (camera.x<0) {camera.x=0;}
    }
    
    if(keydown.right) {
	camera.x += 1;
	if (camera.x>(MAP_WIDTH-camera.width)) {camera.x=MAP_WIDTH-camera.width;}
    }
    
    if(keydown.up) {
	camera.y -= 1;
	if (camera.y<0) {camera.y=0;}
    }
    
    if(keydown.down) {
	camera.y += 1;
	if (camera.y>(MAP_HEIGHT-camera.height)) {camera.y=MAP_HEIGHT-camera.height;}
	
	
    } if(Mode==1){ //edit mode
	if ((defkey.check()) && (keydown.h)) {maps[0].clear()}
	if(edcursor.mode==0){
	    if(keydown.space) {//tile mode
		if(edcursor.type>=41) {
			maps[0].setWall(edcursor.x,edcursor.y,edcursor.type);
		}else{
			maps[0].setTile(edcursor.x,edcursor.y,edcursor.type);
		}
	    }
	    if(keydown.space) {

		//setthings
	    }
	}
	if(serversavekey.check()) {
	    var url = prompt("What do you want to call this map?  (letters/numbers only please.)");
	    var obj = {};
	    obj.tiles = maps[0].stringifyTiles();
		obj.walls = maps[0].stringifyWalls();
	    obj.cracked = maps[0].stringifyCracked();
	    obj.stuff = stringifyStuff();
	    obj.spawners = stringifySpawners();
	    obj.junk = stringifyJunk();
		obj.platforms = maps[0].stringifyPlatforms();
	    obj = JSON.stringify(obj);
	    var form = $("<form />").attr("method", "POST").attr("action", "http://server.webgame.zebra-associates.org/"+url);
	    $("<input />").attr("type", "hidden").attr("name", "map").attr("value", obj).appendTo(form);
	    form.submit();
	}
	if(serverloadkey.check()) {
	    var url = prompt("What map do you want to load?  (letters/numbers only please.)");
            maps[0].loadMapFromServer(url);
	}
	
	if(savekey.check()) {
	    maps[0].saveTiles("edsmap");
		maps[0].saveWalls("edswalls");
	    maps[0].saveCracked("edscrack");
	    maps[0].savePlatforms("edsplatforms");
	    saveStuff("edsstuff");
	    saveSpawners("edsspawners");
	    saveJunk("edsjunk");
	    
	}
	
	if(loadkey.check()) {
	    maps[0].loadTiles("edsmap");
		maps[0].loadWalls("edswalls");
	    maps[0].loadCracked("edscrack");
	    maps[0].loadPlatforms("edsplatforms");
	    loadStuff("edsstuff");
	    loadSpawners("edsspawners");
	    loadJunk("edsjunk");
	}
	
	if(helpkey.check()){
	    alert("W,A,S,D = move cursor, B = tiles/items toggle, Space = Place block, R = remove wall, P = Place Platform, N = switch block/items, Shift= Center Camera on cursor, M= switch to player mode, O = save map, L= loadmap I= WEBSAVE K= WEBLOAD");
	}
	
	if (edcursor.mouse) {
	    edcursor.x=Math.round(Mouse.mX/16)+camera.x;
	    edcursor.y=Math.round(Mouse.mY/16)+camera.y;
	    if(Mouse.mouseIsDown){ //for mouse held
		if((!Mouse.lFlag) && (edcursor.mode==0)) {addEdit(maps[0]);}
		Mouse.lFlag=true;
		if(edcursor.mode==0){
		    //addEdit(maps[0]);
			if(edcursor.type<41){
				maps[0].setTile(edcursor.x,edcursor.y,edcursor.type);
			}else {
				maps[0].setWall(edcursor.x,edcursor.y,edcursor.type);
			}
		}else if(edcursor.mode==1){
		   // NPC mode?
		}else if(edcursor.mode==2){
			if (edcursor.thingtrack==26){
				stuff.push(new thing(edcursor.thingtrack,edcursor.x,edcursor.y,false));
			}else{
				stuff.push(new thing(edcursor.thingtrack,edcursor.x,edcursor.y));
			}
		}
		
		
	    }
	    
	    if((!Mouse.mouseIsDown) && (Mouse.lFlag)){ //for single click
		Mouse.lFlag=false;
		//if((edcursor.mode==0)  || (edcursor.mode==2) ||(edcursor.mode==3) ) {addEdit(maps[0]);}
		if(edcursor.mode==5)
		{
		    if (!edcursor.selected) 
			{
				if (Mouse.isOver(player,camera)) {player.selected=true; edcursor.selected=true;} //todo:this better.
				if (Mouse.isOver(Wizard,camera)) {Wizard.selected=true; edcursor.selected=true;}
				if (Mouse.isOver(Smedly,camera)) {Smedly.selected=true; edcursor.selected=true;}
		    }else
			{
				if (player.selected) {
					player.x=edcursor.x;
					player.y=edcursor.y;
					player.selected=false;
				}else if (Wizard.selected) {
					Wizard.x=edcursor.x;
					Wizard.y=edcursor.y;
					Wizard.selected=false;
				}else if (Smedly.selected) {
					Smedly.x=edcursor.x;
					Smedly.y=edcursor.y;
					Smedly.selected=false;
				}
				edcursor.selected=false;
		    }
		    
		}else if(edcursor.mode==6)
		{
		    if(edcursor.swpselected)
			{
				edcursor.swpselected=false;
				edcursor.swapto=maps[0].tiles[edcursor.x][edcursor.y].data;
				addEdit(maps[0]);
				for (i=0;i<MAP_WIDTH;i++) 
				{
					for (j=0;j<MAP_HEIGHT;j++) 
					{
						if(maps[0].tiles[i][j].data == edcursor.swapfrom) {maps[0].setTile(i,j,edcursor.swapto);}
					}
				}
			}else
			{
				edcursor.swpselected=true;
				edcursor.swapfrom=maps[0].tiles[edcursor.x][edcursor.y].data;
			}
		}else if(edcursor.mode==3){
		    if(edcursor.cornered){
			addEdit(maps[0]);
			twidth=edcursor.x-edcursor.lastx+1;
			theight=edcursor.y-edcursor.lasty+1;
			for (i=edcursor.lastx;i<edcursor.lastx+twidth;i++) {
			    for (j=edcursor.lasty;j<edcursor.lasty+theight;j++) {
				if(edcursor.type < 41){
					maps[0].setTile(i,j,edcursor.type);
				}else{
					maps[0].setWall(i,j,edcursor.type);
				}
			    }
			}
			edcursor.cornered=false;	
		    }else {
			edcursor.lastx=edcursor.x;
			edcursor.lasty=edcursor.y;
			edcursor.cornered=true;
		    }
		}else if(edcursor.mode==4){
		    if(edcursor.cornered){
			addEdit(maps[0]);
			twidth=edcursor.x-edcursor.lastx;
			theight=edcursor.y-edcursor.lasty;
			if(edcursor.type <41){
				for (i=edcursor.lastx;i<edcursor.lastx+twidth;i++) { maps[0].setTile(i,edcursor.lasty,edcursor.type);}
				for (i=edcursor.lastx;i<edcursor.lastx+twidth;i++) {maps[0].setTile(i,edcursor.y,edcursor.type);}
				for (j=edcursor.lasty;j<edcursor.lasty+theight;j++) {maps[0].setTile(edcursor.x,j,edcursor.type);}
				for (j=edcursor.lasty;j<edcursor.lasty+theight;j++) {maps[0].setTile(edcursor.lastx,j,edcursor.type);}
				maps[0].setTile(edcursor.x,edcursor.y,edcursor.type);
			}else{
				for (i=edcursor.lastx;i<edcursor.lastx+twidth;i++) { maps[0].setWall(i,edcursor.lasty,edcursor.type);}
				for (i=edcursor.lastx;i<edcursor.lastx+twidth;i++) {maps[0].setWall(i,edcursor.y,edcursor.type);}
				for (j=edcursor.lasty;j<edcursor.lasty+theight;j++) {maps[0].setWall(edcursor.x,j,edcursor.type);}
				for (j=edcursor.lasty;j<edcursor.lasty+theight;j++) {maps[0].setWall(edcursor.lastx,j,edcursor.type);}
				maps[0].setWall(edcursor.x,edcursor.y,edcursor.type);
			}
			edcursor.cornered=false;
		    }else {
			edcursor.lastx=edcursor.x;
			edcursor.lasty=edcursor.y;
			edcursor.cornered=true;
		    }
		}
	    }
	    
	    if(Mouse.mouseRightDown){
		Mouse.rFlag=true;
	    }
	    if((!Mouse.mouseRightDown) && (Mouse.rFlag)){
		Mouse.rFlag=false;
		if( maps[0].walls[edcursor.x][edcursor.y].cracked==0)
		    {
			maps[0].walls[edcursor.x][edcursor.y].cracked=1;
		    }else
		    maps[0].walls[edcursor.x][edcursor.y].cracked=0;
	    }
	    if(Mouse.wasWheeled) {
		Mouse.wasWheeled=false;
		if(Mouse.mDelta>0) {
		    if((edcursor.mode==0) || (edcursor.mode==3)|| (edcursor.mode==4)){
			edcursor.type++;
		    }else if(edcursor.mode==2){
			edcursor.thingtrack++;
		    }else if(edcursor.mode==1){
			//edcursor.npctype++;
		    }
		    if (edcursor.type > NUM_TILES) {edcursor.type=0;}
		    if (edcursor.thingtrack > NUM_THINGS) {edcursor.thingtrack=0;}
		}else{
		    if((edcursor.mode==0)  || (edcursor.mode==3)|| (edcursor.mode==4)){
			edcursor.type--;
		    }else if(edcursor.mode==2){
			edcursor.thingtrack--;
		    }else if(edcursor.mode==1){
			//edcursor.npctype--;
		    }
		    if (edcursor.type <0) {edcursor.type=NUM_TILES;}
		    if (edcursor.thingtrack <0) {edcursor.thingtrack=NUM_THINGS;}
		} 
	    }
	}
	
	edcursor.getKeys();
	
    }else if(Mode==0) { //bear mode

        maps[0].update();
	
	player.getKeys(maps[0],camera);
	player.update();
	
	
	if(helpkey.check()){
	    alert("WASD = move bear, Arrow keys = move camera, Space = use item, Q= Sword, E= Magic M= switch to edit mode");
	}
    }
    ////process things
    playerBullets.forEach(function(bullet) {  
	    bullet.update(maps[0]);
	});
    
    playerBombs.forEach(function(aBomb) {  
	    aBomb.update(maps[0]);
	});
    
	playerDecoys.forEach(function(aDecoy) {  
	    aDecoy.update(maps[0]);
	});
	
    explosions.forEach(function(aExplosion) {  
	    aExplosion.update();
	});
    
    if (Smedly.active) {
	if (player.hitsword(Smedly.x,Smedly.y,Smedly.width,Smedly.height)){ 
	    Smedly.hurt(player.sword.dmg);
	    
	}
    }
    
    stuff.forEach(function(thing) {
            thing.update(player,maps[0]);
	});
    
    if(!stuff[0]) {gotall=true;} //todo: change smedly requirements
    
    if((gotall) && (player.kills>4) && (Smedly.hp>0))
	{ 
	    Smedly.active=true;
	    gotall=false;
	}
    
    handleCollisions();
    
    playerBullets = playerBullets.filter(function(bullet) {
            return bullet.active;
	});
    
    playerBombs = playerBombs.filter(function(aBomb) {
            return aBomb.active;
	});
    
	playerDecoys = playerDecoys.filter(function(aDecoy) {
            return aDecoy.active;
	});
	
    explosions = explosions.filter(function(aExplosion) {
            return aExplosion.active;
	});
    
    spawners = spawners.filter(function(EnemySpawner) {
            return EnemySpawner.active;
	});
    
    spawners.forEach(function(EnemySpawner) {
            EnemySpawner.update();
	});
    
    enemies.forEach(function(enemy) {
            enemy.update(maps[0]);
	});
    
    enemies = enemies.filter(function(enemy) {
            return enemy.active;
	});
    
    stuff = stuff.filter(function(thing) {
            return thing.active;
	});
    
    
    
    if((Math.random() < 0.1) && (enemies.length<7)) {
	enemies.push(Enemy());
    }
}

player.shoot = function() {
    if (this.mp<2) {return;}
    this.mp-=2;
    playSound("shoot");
    
    var bulletPosition= { x:0,y:0};
    bulletPosition.x=this.x+1;
    bulletPosition.y=this.y+1;
    
    playerBullets.push(Bullet({ 
		speed: 1,
		    dir: this.dir,
		    x: bulletPosition.x,
		    y: bulletPosition.y
		    }));
};

player.trishoot = function() {
    if (this.mp<20) {return;}
    this.mp-=20;
    playSound("shoot");
    
    var bulletPosition= { x:0,y:0};
    bulletPosition.x=this.x+1;
    bulletPosition.y=this.y+1;
    
    if(this.dir==0){
	
	playerBullets.push(Bullet({ 
		    speed: 1,
			dir: this.dir,
			x: bulletPosition.x-1,
			y: bulletPosition.y
			}));
	
	playerBullets.push(Bullet({ 
		    speed: 1,
			dir: this.dir,
			x: bulletPosition.x,
			y: bulletPosition.y
			}));
		  
	playerBullets.push(Bullet({ 
		    speed: 1,
			dir: this.dir,
			x: bulletPosition.x+1,
			y: bulletPosition.y
			}));
	
    }else if (this.dir==1) {
	playerBullets.push(Bullet({ 
		    speed: 1,
		    dir: this.dir,
		    x: bulletPosition.x,
		    y: bulletPosition.y-1
		}));
	
	playerBullets.push(Bullet({ 
		    speed: 1,
			dir: this.dir,
			x: bulletPosition.x,
			y: bulletPosition.y
			}));
	
	playerBullets.push(Bullet({ 
		    speed: 1,
			dir: this.dir,
			x: bulletPosition.x,
			y: bulletPosition.y+1
			}));
	
	
    }else if(this.dir==2) {
	playerBullets.push(Bullet({ 
		    speed: 1,
		    dir: this.dir,
		    x: bulletPosition.x-1,
		    y: bulletPosition.y
		}));
	
	playerBullets.push(Bullet({ 
		    speed: 1,
			dir: this.dir,
			x: bulletPosition.x,
			y: bulletPosition.y
			}));
	
	playerBullets.push(Bullet({ 
		    speed: 1,
			dir: this.dir,
			x: bulletPosition.x+1,
			y: bulletPosition.y
			}));
	
	
    }else if (this.dir==3) {
	playerBullets.push(Bullet({ 
		    speed: 1,
		    dir: this.dir,
		    x: bulletPosition.x,
		    y: bulletPosition.y-1
		}));
	
	playerBullets.push(Bullet({ 
		    speed: 1,
			dir: this.dir,
			x: bulletPosition.x,
			y: bulletPosition.y
			}));
	
	playerBullets.push(Bullet({ 
		    speed: 1,
			dir: this.dir,
			x: bulletPosition.x,
			y: bulletPosition.y+1
			}));
	
    }
};

player.placeBomb = function() {
    if (this.bombs<1) {return;}
    this.bombs--;
    //playSound("placebomb");
    
    ttimeplaced = milliseconds
    
    playerBombs.push(aBomb({ 
		fuse: 4,
		x: this.x,
		y: this.y,
		proxy: false,
		gravity: true,
		timeplaced: ttimeplaced,
		armed: true,
		active: true
	    }));
    
};

player.placeMine = function() {
    if (this.bombs<1) {return;}
    this.bombs--;
    //playSound("placebomb");
    
    ttimeplaced = milliseconds
    
    playerBombs.push(aBomb({ 
		fuse: 400,
		x: this.x,
		y: this.y,
		proxy: true,
		gravity: true,
		timeplaced: ttimeplaced,
		armed: true,
		active: true
	    }));
    
};

player.placeDecoy = function() {
    if (this.bears<1) {return;}
    this.bears--;
    //playSound("placebomb");
    
    ttimeplaced = milliseconds
    
    playerDecoys.push(aDecoy({ 
		fuse: 12,
		x: this.x,
		y: this.y,
		timeplaced: ttimeplaced,
		active: true
	    }));
    
};

player.launchBomb = function() {
    if (this.bombs<1) {return;}
    this.bombs--;
    //playSound("placebomb");
    
    ttimeplaced = milliseconds
    var tar=0;
	var mar=0;
	if (this.dir==1) {tar=2;}
	if (this.dir==3) {tar=-2;}
	if (this.dir==0) {mar=-2;}
	if (this.dir==2) {mar=2;}
	if(SideMode) {mar+=this.aim;}
    playerBombs.push(aBomb({ 
		fuse: 2,
		x: this.x,
		y: this.y,
		xv: tar,
		yv: mar,
		proxy: true,
		gravity: false,
		timeplaced: ttimeplaced,
		armed: true,
		active: true
	    }));
    
};

function addEdit(merp){
    //if(editHistory.length>6) {editHistory.shift();}
	var obj= {};
    obj.tiles=merp.stringifyTiles();
	obj.walls=merp.stringifyWalls();
    editHistory.push(obj);
}
function undoEdit(){
    if(editHistory.length<1){ return;}
    var obj=editHistory.pop();

    if (!obj) {  alert ("Nothing to undo.");return;}
    maps[0].buildMapFromLoadedTiles( "name", obj.tiles);
    maps[0].buildMapFromLoadedWalls( "name", obj.walls);
};


function draw() { //Main render function
    canvas.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
    
    
    maps.forEach(function(imap) {
            imap.draw(camera);
	});
    
    
    if(Mode==1) { edcursor.draw(camera);}
    
    playerBullets.forEach(function(bullet) {
            bullet.draw(camera);
	});
    
    playerBombs.forEach(function(aBomb) {
	    aBomb.draw(camera);
	});
    
	playerDecoys.forEach(function(aDecoy) {
	    aDecoy.draw(camera);
	});
    stuff.forEach(function(thing) {
            thing.draw(camera);
	});
    
    spawners.forEach(function(EnemySpawner) {
            EnemySpawner.draw(camera);
	});
    
    enemies.forEach(function(enemy) {
            enemy.draw(camera);
	});
    
    if(Smedly.active){
	Smedly.draw(camera);
    }
    
    player.draw(camera);
    
    explosions.forEach(function(aExplosion) {
            aExplosion.draw(camera);
	});
    
    Wizard.draw(camera);
    if(Mode==0){
	player.drawHearts();
	player.drawmp();
    }else{
	canvas.font = "16pt Calibri";
	canvas.textAlign = "left";
	canvas.textBaseline = "middle";
	canvas.fillStyle = "white";
	canvas.fillText("EDIT MODE", 16, 16);
	
	//deug
	canvas.fillText(edcursor.swpselected,105, 120);	
	
	if(edcursor.mode==0) {
	    canvas.fillText("Placing Tiles", 16, 42);
	}else if (edcursor.mode==1) {
	    canvas.fillText("Doing Nothing!", 16, 42);
	    
	}else if(edcursor.mode==2) {
	    canvas.fillText("Placing Item", 16, 42);
		edititems[edcursor.thingtrack].sprite.draw(canvas,130,36);
	}else if(edcursor.mode==3) {
	    canvas.fillText("Solid Rect", 16, 42);
	    if(!edcursor.cornered) {	
		canvas.fillText("Select Top-Left Corner", 16, 64);
	    }else{
		canvas.fillText("Select Bottom-Right Corner", 16, 64);
	    }
	}else if(edcursor.mode==4) {
	    canvas.fillText("Empty Rect", 16, 42);
	    if(!edcursor.cornered) {	
		canvas.fillText("Select Top-Left Corner", 16, 64);
	    }else{
		canvas.fillText("Select Bottom-Right Corner", 16, 64);
	    }
	}else if(edcursor.mode==5) {
	    canvas.fillText("Move Entity Mode", 16, 42);
	    if(!edcursor.selected) {	
		canvas.fillText("Select entity to move.", 16, 64);
	    }else{
		canvas.fillText("Select desired position.", 16, 64);
	    }
	}else if(edcursor.mode==6) {
	    canvas.fillText("Tile Swap Mode", 16, 42);
	    if(!edcursor.swpselected) {	
		canvas.fillText("Select tile to be replaced.", 16, 64);
	    }else{
		canvas.fillText("Select replacement tile.", 16, 64);
	    }
	}
    }
    
    
    
    maps.forEach(function(imap) {
	    imap.drawRadar(camera, 645, 466,player.x,player.y);
	});
    if(Mouse.isOver(Wizard,camera)){
	if((Math.abs(player.x-Wizard.x<12)) && Math.abs((player.y-Wizard.y<12)))
	    {
		if(player.sword==woodsword)
		    {
			textbox("Old Man: It is said that across the sea lives an elephant who never forgets....TO KILL!");
		    }else
		    textbox("Old Man: it is dangerous to go alone, take this.");
	    }
    }
    
}

function updateBombedTiles(px,py,r,merp){
    for(i=px-1;i<px+r;i++){
	for(j=py-1;j<py+r;j++){
	    if ((i>merp.width-1) || (j>merp.height-1) || (i<0) || (j<0)) {return;}
	    if (merp.walls[i][j].cracked==1){
		merp.walls[i][j].data=0;
		merp.walls[i][j].cracked=0;
	    }
	}
    }
}

function handleCollisions() {
    playerBombs.forEach(function(aBomb) {
            enemies.forEach(function(enemy) {
		    if(enemy.checkCollide(aBomb)) {
				if(aBomb.proxy) {aBomb.explode();}
		    }
		});
	});
	
	playerBullets.forEach(function(bullet) {
            enemies.forEach(function(enemy) {
		    if(bullet.checkHit(enemy)) {
			enemy.hurt(5);
			bullet.active = false;
		    }
		});
	});
    
    spawners.forEach(function(EnemySpawner) {
	    if(player.checkCollide(EnemySpawner)) {player.hurt(EnemySpawner.contactDmg);}
	    if(player.hitsword(EnemySpawner.x,EnemySpawner.y,32,32)) {
		EnemySpawner.hurt(player.sword.dmg);
	    }
	});
    
    
    enemies.forEach(function(enemy) {
	    if(player.checkCollide(enemy)) {player.hurt(enemy.contactDmg);}
	    if(player.hitsword(enemy.x,enemy.y,32,32)) {
		enemy.hurt(player.sword.dmg);
	    }
	});
    
    
    explosions.forEach(function(aExplosion) {
			  updateBombedTiles(aExplosion.x,aExplosion.y,4,maps[0]);
			  enemies.forEach(function(enemy) {
				  if (enemy.checkCollide(aExplosion)) {enemy.hurt(30);}
			      });
			  
			  spawners.forEach(function(EnemySpawner) {
				  if (EnemySpawner.checkCollide(aExplosion)) {EnemySpawner.hurt(30);}
			      });
			  
			  if(player.checkCollide(aExplosion)) {player.hurt(30);}
			  if((Smedly.active) && (aExplosion.checkCollide(Smedly))) {Smedly.hurt(30);}
	});
    
    if(Smedly.active){
	Smedly.update(maps[0]);
	if(player.checkCollide(Smedly)) {player.hurt(10);}
	
	playerBullets.forEach(function(bullet) {
		if (bullet.checkHit(Smedly)) {Smedly.hurt(5);}
	    });
	
    }
}

player.move=function (px,py,merp) {
    if(this.frozen) {return;}
    var slowed=0;
    if(this.tiletype==44) {slowed=30;}
    if(milliseconds-this.timelastmoved<this.speed+slowed){ return; }
    if (this.tiletype==42) {playSound("Swim");}
    if(milliseconds-this.timelastmoved<this.speed){ return; }
    if (this.tiletype==44) {playSound("GrassWalk");}
    if (this.tiletype==20) {this.hurt(3);} //poison ground
    this.x+=px;
    this.y+=py
    this.tiletype=merp.walls[this.x][this.y].data;
    this.timelastmoved=milliseconds;
    camera.center(this);
    this.animate();
    
};


player.draw = function(cam) {
    if (textPause) {
	this.grabsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	this.grabedsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16-24);
	textbox(textText);
	return;
    }
    if (this.gothurt>0) {
	this.gothurt--;
	canvas.save();
	if(this.gothurt%2==0){canvas.globalAlpha = 0.5;}
	this.sprites[this.dir][this.ani].draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	canvas.restore();
    }else
	{
	    this.sprites[this.dir][this.ani].draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	}
	
	if(this.curitem==2) { //draw launcher if equipped
	if(this.dir==1){launcherrsprite.draw(canvas, (this.x-cam.x+1)*16-12, (this.y-cam.y+1)*16-6);}
	if(this.dir==3){launcherlsprite.draw(canvas, (this.x-cam.x+1)*16-24, (this.y-cam.y+1)*16-6);}
	if(this.dir==0){launcherusprite.draw(canvas, (this.x-cam.x+1)*16-16, (this.y-cam.y+1)*16-18);}
	if(this.dir==2){launcherdsprite.draw(canvas, (this.x-cam.x+1)*16+2, (this.y-cam.y+1)*16-7);}
	
    }
	
	if((this.falling) && (this.chute) && (this.curitem==4)){
		if(player.dir<3)
		{
			chutersprite.draw(canvas, (this.x-cam.x+1)*16-14, (this.y-cam.y+1)*16-34);
		}else {
			chutelsprite.draw(canvas, (this.x-cam.x+1)*16-14, (this.y-cam.y+1)*16-34)
		}
	}
	
	if(player.firetunic){ //todo enable.
		//fireshirtsprite[this.dir].draw(canvas, (this.x-cam.x+1)*16-18, (this.y-cam.y+1)*16-6)
	}
    
    //cover player in grass if neccisary
    if(maps[0].walls[this.x][this.y+1].data==44) {
	darkgrasssprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y+1)*16);
	
    }
    if(maps[0].walls[this.x+1][this.y+1].data==44) {
	darkgrasssprite.draw(canvas, (this.x-cam.x+1)*16, (this.y-cam.y+1)*16);
	
    }
    
    
    //cover player in water if neccisary
    canvas.save();
    canvas.globalAlpha=.60;
    if(maps[0].walls[this.x][this.y+1].data==42) {
	watersprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y+1)*16);
	
    }
    if(maps[0].walls[this.x+1][this.y+1].data==42) {
	watersprite.draw(canvas, (this.x-cam.x+1)*16, (this.y-cam.y+1)*16);
	
    }
    canvas.restore();
    
    if (this.magicShield){
	canvas.save();
	canvas.globalAlpha=.5;
	shieldsprite.draw(canvas, (this.x-cam.x)*16-16, (this.y-cam.y)*16-16);
	canvas.restore();
    }
    
    if (this.frozen){
	canvas.save();
	canvas.globalAlpha=.5;
	icesprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
	canvas.restore();
    }
    
    this.drawsword(cam);
    
    if(Mouse.isOver(player,cam)) {drawmousetext(player,cam);}
    
};


      //]]>
    </script>

  </body>
</html>

