<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>TEST</title>
    <link href="/stylesheets/screen.css" media="all" rel="stylesheet" type="text/css"/>
    <script language="javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js" type="text/javascript"></script><script language="javascript" src="javascripts/jquery.hotkeys.js" type="text/javascript"></script><script language="javascript" src="javascripts/key_status.js" type="text/javascript"></script><script language="javascript" src="javascripts/util.js" type="text/javascript"></script><script language="javascript" src="javascripts/sprite.js" type="text/javascript"></script><script language="javascript" src="javascripts/sound.js" type="text/javascript"></script>
  </head>
  <body>
    <h1>Tile Test</h1>
    <script type='text/javascript'>
      //<![CDATA[
        var CANVAS_WIDTH = 900;
        var CANVAS_HEIGHT = 640;
		var MAP_WIDTH = 120;
        var MAP_HEIGHT = 80;
        var FPS = 30;
		Mode = 1;
		
		/*var tile = {
		   width: 32,
		   height: 32,
		   x: 0,
		   y: 0,
		   color: "#000",
		   data: 0,
		   draw: function() {
            canvas.fillStyle = this.color;
            canvas.fillRect(this.x, this.y, this.width, this.height);
          }
		};*/
		
		var camera = {
		    x: 0,
			y: 0,
			width: 52,
			height: 40,
			lock: function(targ) {
				this.x=targ.x-26;
				this.y=targ.y-20;
			},
			check: function() {
			    this.x.clamp(0, MAP_WIDTH-52);
				this.y.clamp(0, MAP_HEIGHT-40);
			},
			rX: function(fx)
			{
				return fx-this.x;
			},
			rY: function(fy)
			{
				return fy-this.y;
			}
		};
			
		
		
        var bColors = ["#000080","#FFC000", "#FFC040", "#FFC060", "#FFC080", "#FFD700", "#FFC0C0", "#FFC0FF", "#FFFF00", "#FFFF20", "#FFFF40", "#FFFF60", "#FFFF80"];
		function makeNewTile() { 

		    var tile = {
                width: 16,
				height: 16,
				x: 0,
				y: 0,
				color: "#FFC020",
				data: 0,
				draw: function(cam) { 
				    canvas.fillStyle = bColors[this.data]; 
					canvas.fillRect((this.x-cam.x)*this.width, (this.y-cam.y)*this.height, this.width, this.height);
					}	
				};
			
            return tile;
		};
		
        var player = {
          color: "#00A",
          x: 1,
          y: 1,
		  dir: 0,
		  type: 0,
          width: 32,
          height: 32,
          draw: function(cam) {
            canvas.fillStyle = bColors[this.type];
            canvas.fillRect((this.x-cam.x)*16, (this.y-cam.y)*16, this.width, this.height);
          },
		  getKeys: function(merp) {

			
			  if(keydown.left) {
			    this.dir=3;
			    if (merp.tiles[this.x-1][this.y].data==0) {this.x -= 1;}
			  }
			
			  if(keydown.right) {
			    this.dir=1;
				if (merp.tiles[this.x+2][this.y].data==0) {this.x += 1;}
			  }
			  
			  if(keydown.up) {
			    this.dir=0;
				if (merp.tiles[this.x][this.y-1].data==0) {this.y -= 1;}
			  }
			
			  if(keydown.down) {
			    this.dir=2;
				if (merp.tiles[this.x][this.y+2].data==0) {this.y += 1;}
			  }
			  this.x = this.x.clamp(0, MAP_WIDTH-1);
			  this.y = this.y.clamp(0, MAP_HEIGHT-1);
		  }
        
        };
		
		 var edcursor = {
          color: "#00A",
          x: 1,
          y: 1,
		  type: 0,
          width: 16,
          height: 16,
          draw: function(cam) {
            canvas.fillStyle = bColors[this.type];
            canvas.fillRect((this.x-cam.x)*16, (this.y-cam.y)*16, this.width, this.height);
          },
		  getKeys: function() {
		  
			  if(keydown.shift) { 
				  this.type++;
				  if (this.type > 11) {this.type=0;}
			  }
			
			  if(keydown.left) {
				this.x -= 1;
			  }
			
			  if(keydown.right) {
				this.x += 1;
			  }
			  
			  if(keydown.up) {
				this.y -= 1;
			  }
			
			  if(keydown.down) {
				this.y += 1;
			  }
			  this.x = this.x.clamp(0, MAP_WIDTH-1);
			  this.y = this.y.clamp(0, MAP_HEIGHT-1);
		  }
        };
        
        var playerBullets = [];
        
		function Map(I) {
            I = I || {};
		    var i = 0;
			var j = 0;
		    I.active = true;
            I.color = "#00A";
            I.tiles = new Array(120);
			for( i=0; i<MAP_WIDTH; i++ ) { I.tiles[i] = new Array(80); }
		  for (i=0;i<MAP_WIDTH; i++){
		    for (j=0;j<MAP_HEIGHT; j++){
		        I.tiles[i][j]= makeNewTile();
				I.tiles[i][j].x=i;
				I.tiles[i][j].y=j;
				}
			}
          I.width = MAP_WIDTH;
          I.height = MAP_HEIGHT;
          I.draw = function(cam) {
		    cam.check();
		    for (i=cam.x;i<MAP_WIDTH; i++){
		        for (j=cam.y;j<MAP_HEIGHT; j++){
		            I.tiles[i][j].draw(cam);
				}
			}
         };
		 
		   I.setTile = function (x,y,data) {
		       I.tiles[x][y].data = data;
			};
		   I.canWalk = function (x,y) {
		      if (I.tiles[x][y].data ==0) {
				return true;
			  }else {return false;}
		   };
		   return I;
        }
		
		
        function Bullet(I) {
          I.active = true;
        
          if(I.dir==0){
			I.xVelocity = 0;
			I.yVelocity = -I.speed;
		 }else if(I.dir==1){
			I.xVelocity = +I.speed;
			I.yVelocity = 0;
		 }else if(I.dir==2){
			I.xVelocity = 0;
			I.yVelocity = +I.speed;
		 }else if(I.dir==3){
			I.xVelocity = -I.speed;
			I.yVelocity = 0;
		 }
          I.width = 3;
          I.height = 3;
		  I.dir = 1;
          I.color = "#000";
        
          I.inBounds = function() {
            return I.x >= 0 && I.x <= CANVAS_WIDTH &&
              I.y >= 0 && I.y <= CANVAS_HEIGHT;
          };
        
          I.draw = function(cam) {
            canvas.fillStyle = this.color;
            canvas.fillRect((this.x-cam.x)*16, (this.y-cam.y)*16, this.width, this.height);
          };
          
          I.update = function() {
            I.x += I.xVelocity;
            I.y += I.yVelocity;
        
            I.active = I.active && I.inBounds();
          };
        
          I.explode = function() {
            this.active = false;
            // Extra Credit: Add an explosion graphic
          };
		  
		  I.hitWall = function(merp) {
		    if(I.active==false) {return;}
			if (merp.tiles[I.x][I.y].data>0) {
			    I.active=false;
			}
		  }
        
          return I;
        }
        
        enemies = [];
        maps = [];
		maps.push(Map());
        function Enemy(I) {
          I = I || {};
        
          I.active = true;
          I.age = Math.floor(Math.random() * 128);
          
          I.color = "#A2B";
        
          I.x = CANVAS_WIDTH / 4 + Math.random() * CANVAS_WIDTH / 2;
          I.y = 0;
          I.xVelocity = 0
          I.yVelocity = 2;
        
          I.width = 32;
          I.height = 32;
        
          I.inBounds = function() {
            return I.x >= 0 && I.x <= CANVAS_WIDTH &&
              I.y >= 0 && I.y <= CANVAS_HEIGHT;
          };
        
          I.sprite = Sprite("enemy");
        
          I.draw = function() {
            this.sprite.draw(canvas, this.x, this.y);
          };
        
          I.update = function() {
            I.x += I.xVelocity;
            I.y += I.yVelocity;
        
            I.xVelocity = 3 * Math.sin(I.age * Math.PI / 64);
        
            I.age++;
        
            I.active = I.active && I.inBounds();
          };
        
          I.explode = function() {
            Sound.play("explosion");
        
            this.active = false;
            // Extra Credit: Add an explosion graphic
          };
        
          return I;
        };
        
        var canvasElement = $("<canvas width='" + CANVAS_WIDTH + 
          "' height='" + CANVAS_HEIGHT + "'></canvas");
        var canvas = canvasElement.get(0).getContext("2d");
        canvasElement.appendTo('body');
        
        setInterval(function() {
          update();
          draw();
        }, 1000/FPS);
		
			        
        function update() {
		    if(keydown.m) {
				if (Mode==0) {
					Mode=1;
				}else if (Mode==1) {
				    Mode=2;
				}else if (Mode==2) {
				    Mode=0;
				}
					
			 }
		    if (true){ //camera mode
			 			
			  if(keydown.a) {
				camera.x -= 1;
				if (camera.x<0) {camera.x=0;}
			  }
			
			  if(keydown.d) {
				camera.x += 1;
				if (camera.x>(MAP_WIDTH-camera.width)) {camera.x=MAP_WIDTH-camera.width;}
			  }
			  
			  if(keydown.w) {
				camera.y -= 1;
				if (camera.y<0) {camera.y=0;}
			  }
			
			  if(keydown.s) {
				camera.y += 1;
				if (camera.y>(MAP_HEIGHT-camera.height)) {camera.y=MAP_HEIGHT-camera.height;}
			  }
			 

		  } if(Mode==1){ //edit mode
			  if(keydown.space) {
				maps[0].setTile(edcursor.x,edcursor.y,edcursor.type);
			  }
			  
			  edcursor.getKeys();
		  }else if(Mode==2) {
			player.getKeys(maps[0]);
					  	  if(keydown.shift) { 
				  player.shoot();
			  }
		 }
        
			  playerBullets.forEach(function(bullet) {
				bullet.update();
			  });
		  
          playerBullets = playerBullets.filter(function(bullet) {
            return bullet.active;
          });
          
          enemies.forEach(function(enemy) {
            enemy.update();
          });
        
          enemies = enemies.filter(function(enemy) {
            return enemy.active;
          });
        
          handleCollisions();
        
          if(Math.random() < 0.1) {
            //enemies.push(Enemy());
          }
        }
        
        player.shoot = function() {
          Sound.play("shoot");
        
          var bulletPosition = this.midpoint();
		  bulletPosition.x=this.x;
		  bulletPosition.y=this.y;
        
          playerBullets.push(Bullet({ 
            speed: 2,
			dir: this.dir,
            x: bulletPosition.x,
            y: bulletPosition.y
          }));
        };
        
        player.midpoint = function() {
          return {
            x: this.x + this.width/2,
            y: this.y + this.height/2
          };
        };
        
        function draw() {
          canvas.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

		  
		 maps.forEach(function(imap) {
            imap.draw(camera);
         });
		 if(true) { player.draw(camera);}
		 if(true) { edcursor.draw(camera);}
          
          playerBullets.forEach(function(bullet) {
            bullet.draw(camera);
			bullet.hitWall(maps[0]);
          });
        
          enemies.forEach(function(enemy) {
            enemy.draw(camera);
          });
        }
        
        function collides(a, b) {
          return a.x < b.x + b.width &&
            a.x + a.width > b.x &&
            a.y < b.y + b.height &&
            a.y + a.height > b.y;
        }
		
      
        function handleCollisions() {
          playerBullets.forEach(function(bullet) {
            enemies.forEach(function(enemy) {
              if(collides(bullet, enemy)) {
                enemy.explode();
                bullet.active = false;
              }
            });
          });
        
          enemies.forEach(function(enemy) {
            if(collides(enemy, player)) {
              enemy.explode();
              player.explode();
            }
          });
        }
        
        player.explode = function() {
          this.active = false;
          // Extra Credit: Add an explosion graphic and then end the game
        };
        
        player.sprite = Sprite("player");
        
        player.draw = function(cam) {
          this.sprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
        };
      //]]>
    </script>
  </body>
</html>
