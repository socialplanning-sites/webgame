<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>Oh also W,A,S,D moves the camera.</title>
    <link href="/stylesheets/screen.css" media="all" rel="stylesheet" type="text/css"/>
    <script language="javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js" type="text/javascript"></script><script language="javascript" src="javascripts/jquery.hotkeys.js" type="text/javascript"></script><script language="javascript" src="javascripts/key_status.js" type="text/javascript"></script><script language="javascript" src="javascripts/util.js" type="text/javascript"></script><script language="javascript" src="javascripts/sprite.js" type="text/javascript"></script><script language="javascript" src="javascripts/sound.js" type="text/javascript"></script>
  </head>
  <body>
    <h1>M= Mode | Space= shoot/place block | Shift= center camera on player/cursor </h1>
    <script type='text/javascript'>
      //<![CDATA[
        var CANVAS_WIDTH = 900;
        var CANVAS_HEIGHT = 640;
		var MAP_WIDTH = 120;
        var MAP_HEIGHT = 80;
        var FPS = 30;
		//var keychart = ["w","a","d","s","up","right","down","left","m","n","shift"];
		var darkgrasssprite = Sprite("darkgrass");
		var grasssprite = Sprite("grass");
		var watersprite = Sprite("water");
		var lavasprite = Sprite("lava");
		var rocksprite = Sprite("stone2");
		var bricksprite = Sprite("brick");
		var dirtsprite = Sprite("dirt");
		var crystalsprite = Sprite("crystalfloor");
		var mudsprite = Sprite("mud");
		var obsidiansprite = Sprite("obsidian");
		var mossysprite = Sprite("mossy");
		var stonesprite = Sprite("stone");
		Mode = 1;
		var playerBullets = [];
		//var keyboard = [];
		//for (l=0;l<10;l++){keyboard.push(akey(keychart[l]));}

			
		function akey(k) {
		    k = k || "space";
			aflag=false;
			check= function(){
				if (keydown[k]) { 
					aflag=true;
					return false;
				}
				if((!keydown[k]) && (aflag==true)){
					aflag=false;
					return true;
				}
		    };
			return this;
		}
		
		var wkey=akey("w");
		var aakey=akey("a");
		var skey=akey("s");
		var dkey=akey("d");
	    var upkey=akey("up");
		var rightkey=akey("right");
		var downkey=akey("down");
		var leftkey=akey("left");
		var modekey=akey("m");
		var nkey=akey("n");
		var shiftkey=akey("shift");
		
		var camera = {
		    x: 0,
			y: 0,
			width: 52,
			height: 40,
			center: function(targ) {
			    tx=targ.x-26;
				ty=targ.y-20;
				if (tx<0) {tx=0;}
				if (ty<0) {ty=0;}
				if (tx>MAP_WIDTH-52) {tx=MAP_WIDTH-52;}
				if (ty>MAP_HEIGHT-40) {ty=MAP_HEIGHT-40;}

				this.x=tx;
				this.y=ty;
			},
			check: function() {
			    this.x.clamp(0, MAP_WIDTH-52);
				this.y.clamp(0, MAP_HEIGHT-40);
			},
			rX: function(fx)
			{
				return fx-this.x;
			},
			rY: function(fy)
			{
				return fy-this.y;
			}
		};
				
        var bColors = ["#000080","#FFC000", "#FFC040", "#FFC060", "#FFC080", "#FFD700", "#FFC0C0", "#FFC0FF", "#FFFF00", "#FFFF20", "#FFFF40", "#FFFF60", "#FFFF80"];
		function makeNewTile() { 
		    var tile = {
                width: 16,
				height: 16,
				x: 0,
				y: 0,
				color: "#FFC020",
				data: 0,
				draw: function(cam) { 
				    if(this.data==0){
					   grasssprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.data==1){
					   watersprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.data==2){
					   lavasprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.data==3){
					   rocksprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.data==4){
					   stonesprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.data==5){
					   obsidiansprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.data==6){
					   mudsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.data==7){
					   bricksprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.data==8){
					   dirtsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.data==9){
					   rocksprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.data==10){
					   crystalsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.data==11){
					   darkgrasssprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else{
				       canvas.fillStyle = bColors[this.data]; 
					   canvas.fillRect((this.x-cam.x)*this.width, (this.y-cam.y)*this.height, this.width, this.height);
					}
				}
				};
			
            return tile;
		};
		
        var player = {
          color: "#00A",
          x: 30,
          y: 20,
		  dir: 0,
		  type: 0,
          width: 32,
          height: 32,
          draw: function(cam) {
            canvas.fillStyle = bColors[this.type];
            canvas.fillRect((this.x-cam.x)*16, (this.y-cam.y)*16, this.width, this.height);
          },
		  getKeys: function(merp) {
			  if(keydown.left) {
			    this.dir=3;
			    if (merp.tiles[this.x-1][this.y].data==0) {this.x -= 1;}
			  }
			
			  if(keydown.right) {
			    this.dir=1;
				if (merp.tiles[this.x+2][this.y].data==0) {this.x += 1;}
			  }
			  
			  if(keydown.up) {
			    this.dir=0;
				if (merp.tiles[this.x][this.y-1].data==0) {this.y -= 1;}
			  }
			
			  if(keydown.down) {
			    this.dir=2;
				if (merp.tiles[this.x][this.y+2].data==0) {this.y += 1;}
			  }
			  this.x = this.x.clamp(0, MAP_WIDTH-1);
			  this.y = this.y.clamp(0, MAP_HEIGHT-1);
		  }
        
        };
		
		 var edcursor = {
          color: "#00A",
          x: 1,
          y: 1,
		  size: 1, //TODO: add for loops to draw, placement to make larger brush size, center it?
		  type: 1,
          width: 16,
          height: 16,
          draw: function(cam) {
            	    if(this.type==0){
					   grasssprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.type==1){
					   watersprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.type==2){
					   lavasprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.type==3){
					   rocksprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.type==4){
					   stonesprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.type==5){
					   obsidiansprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.type==6){
					   mudsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.type==7){
					   bricksprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.type==8){
					   dirtsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.type==9){
					   rocksprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.type==10){
					   crystalsprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else if(this.type==11){
					   darkgrasssprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
					}else{
				       canvas.fillStyle = bColors[this.data]; 
					   canvas.fillRect((this.x-cam.x)*this.width, (this.y-cam.y)*this.height, this.width, this.height);
					}
          },
		  getKeys: function() {
		  	  if(shiftkey.check()) { 
				  this.type++;
				  if (this.type > 11) {this.type=0;}
			  }
			
			  if(keydown.left) {
				this.x -= 1;
			  }
			
			  if(keydown.right) {
				this.x += 1;
			  }
			  
			  if(keydown.up) {
				this.y -= 1;
			  }
			
			  if(keydown.down) {
				this.y += 1;
			  }
			  this.x = this.x.clamp(0, MAP_WIDTH-1);
			  this.y = this.y.clamp(0, MAP_HEIGHT-1);
		  }
        };
        
		function Map(I) {
            I = I || {};
		    var i = 0;
			var j = 0;
		    I.active = true;
            I.color = "#00A";
            I.tiles = new Array(120);
			for( i=0; i<MAP_WIDTH; i++ ) { I.tiles[i] = new Array(80); }
		    for (i=0;i<MAP_WIDTH; i++){
		        for (j=0;j<MAP_HEIGHT; j++){
					I.tiles[i][j]= makeNewTile();
					I.tiles[i][j].x=i;
					I.tiles[i][j].y=j;
				}
			}
            I.width = MAP_WIDTH;
            I.height = MAP_HEIGHT;
            I.draw = function(cam) {
				cam.check();
				for (i=cam.x;i<cam.x+cam.width; i++){
					for (j=cam.y;j<cam.y+cam.height; j++){
						I.tiles[i][j].draw(cam);
					}
				}
			};
		    I.saveTiles = function (name) {
			    var myString = JSON.stringify(I.tiles); //!?!
				localStorage.setItem(name, myString);
			};
		    I.loadTiles = function (name) {
				poop=localStorage.getItem(name);
				var myObject = JSON.parse(poop);
				I.tiles=myObject;
			};
		    I.setTile = function (x,y,data) {
		       I.tiles[x][y].data = data;
			};
		    I.canWalk = function (x,y) {
		      if (I.tiles[x][y].data ==0) {
				return true;
			  }else {return false;}
		    };
			I.drawRadar= function (cam,x,y) {
				cam.check();
				for (i=cam.x;i<cam.x+cam.width; i++){
					for (j=cam.y;j<cam.y+cam.height; j++){
						//TODO: draw pixel at x+i,y+j or col color
					}
				}
			};
		    return I;
        }
		
		
        function Bullet(I) {
          I.active = true;
        
          if(I.dir==0){
			I.xVelocity = 0;
			I.yVelocity = -I.speed;
		  }else if(I.dir==1){
			I.xVelocity = +I.speed;
			I.yVelocity = 0;
		  }else if(I.dir==2){
			I.xVelocity = 0;
			I.yVelocity = +I.speed;
		  }else if(I.dir==3){
			I.xVelocity = -I.speed;
			I.yVelocity = 0;
		  }
          I.width = 3;
          I.height = 3;
		  I.dir = 1;
          I.color = "#000";
        
          I.inBounds = function() {
            return I.x >= 0 && I.x <= MAP_WIDTH &&
              I.y >= 0 && I.y <= MAP_HEIGHT;
          };
        
          I.draw = function(cam) {
            canvas.fillStyle = this.color;
            canvas.fillRect((this.x-cam.x)*16, (this.y-cam.y)*16, this.width, this.height);
          };
          
          I.update = function(merp) {
            I.x += I.xVelocity;
            I.y += I.yVelocity;
        
            I.active = I.active && I.inBounds();
			if((I.x>MAP_WIDTH-1) || (I.y>MAP_HEIGHT-1) || (I.x<0) || (I.y<0)) {
				I.active=false;
			}else if(merp.tiles[I.x][I.y].data>0) {I.active=false;} //todo:play a ding sound
			
          };
        
          I.explode = function() {
            this.active = false;
            // Extra Credit: Add an explosion graphic
          };
		  
      
          return I;
        }
        
        enemies = [];
        maps = [];
		maps.push(Map());
        function Enemy(I) {
          I = I || {};
        
          I.active = true;
          I.age = Math.floor(Math.random() * 128);
          
          I.color = "#A2B";
        
          I.x = 5
          I.y = 5;
          I.xVelocity = 0
          I.yVelocity = 1;
        
          I.width = 32;
          I.height = 32;
        
          I.inBounds = function() {
            return I.x >= 0 && I.x <= MAP_WIDTH &&
              I.y >= 0 && I.y <= MAP_HEIGHT;
          };
        
          I.sprite = Sprite("enemy");
        
          I.draw = function(cam) {
            this.sprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
          };
        
          I.update = function() {
            I.x += I.xVelocity;
            I.y += I.yVelocity;
        
            //I.xVelocity = 3 * Math.sin(I.age * Math.PI / 64);
        
            I.age++;
        
            I.active = I.active && I.inBounds();
          };
        
          I.explode = function() {
            Sound.play("explosion");
        
            this.active = false;
            // Extra Credit: Add an explosion graphic
          };
        
          return I;
        };
        
        var canvasElement = $("<canvas width='" + CANVAS_WIDTH + 
          "' height='" + CANVAS_HEIGHT + "'></canvas");
        var canvas = canvasElement.get(0).getContext("2d");
        canvasElement.appendTo('body');
		
		//canvas.globalAlpha = 0.85;//todo: something with this
		
        
        setInterval(function() {
          update();
          draw();
        }, 1000/FPS);
		
	
        function update() {
		    if(modekey.check()) {
				if (Mode==0) {
					Mode=1;
					camera.center(edcursor);
				}else if (Mode==1) {
				    Mode=0;
					camera.center(player); 
				}else if (Mode==2) {
				    Mode=0;
				}
					
			 }
			  /*if(shiftkey.check()) { 
			  if (Mode==0) {  camera.center(player); }
			  if (Mode==1) {  camera.center(edcursor); }
			  }*/
			  //if(keyboard[0].check()) {alert(keyboard.length);}
		    if (true){ //camera mode
			 			
			  if(keydown.a) {
				camera.x -= 1;
				if (camera.x<0) {camera.x=0;}
			  }
			
			  if(keydown.d) {
				camera.x += 1;
				if (camera.x>(MAP_WIDTH-camera.width)) {camera.x=MAP_WIDTH-camera.width;}
			  }
			  
			  if(keydown.w) {
				camera.y -= 1;
				if (camera.y<0) {camera.y=0;}
			  }
			
			  if(keydown.s) {
				camera.y += 1;
				if (camera.y>(MAP_HEIGHT-camera.height)) {camera.y=MAP_HEIGHT-camera.height;}
			  }
			 

		  } if(Mode==1){ //edit mode
			  if(keydown.space) {
				maps[0].setTile(edcursor.x,edcursor.y,edcursor.type);
			  }
			  if(keydown.h) {
				maps[0].saveTiles("edsmap");
			  }
			  			  
			  if(keydown.l) {
				maps[0].loadTiles("edsmap");
			  }
			  
			  edcursor.getKeys();
		  }else if(Mode==0) {
			player.getKeys(maps[0]);
		     if(keydown.space) { 
				  player.shoot();
			  }
			  camera.center(player);
		  }
        
			  playerBullets.forEach(function(bullet) {
				bullet.update(maps[0]);
			  });
		  
		  handleCollisions();
          playerBullets = playerBullets.filter(function(bullet) {
            return bullet.active;
          });
          
          enemies.forEach(function(enemy) {
            enemy.update();
          });
        
          enemies = enemies.filter(function(enemy) {
            return enemy.active;
          });
        
          
        
          if((Math.random() < 0.1) && (enemies.length<5)) {
            //enemies.push(Enemy());
          }
        }
        
        player.shoot = function() {
          if (playerBullets.length>9) {return;}
		  Sound.play("shoot");
        
          var bulletPosition = this.midpoint();
		  bulletPosition.x=this.x;
		  bulletPosition.y=this.y;
        
          playerBullets.push(Bullet({ 
            speed: 1,
			dir: this.dir,
            x: bulletPosition.x,
            y: bulletPosition.y
          }));
        };
        
        player.midpoint = function() {
          return {
            x: this.x + this.width/2,
            y: this.y + this.height/2
          };
        };
        
        function draw() {
          canvas.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

		  
		 maps.forEach(function(imap) {
            imap.draw(camera);
			imap.drawRadar(camera, 728, 100);
         });
		 
		 
		 
		 if(true) { player.draw(camera);}
		 if(true) { edcursor.draw(camera);}
          
          playerBullets.forEach(function(bullet) {
            bullet.draw(camera);
          });
        
          enemies.forEach(function(enemy) {
            enemy.draw(camera);
          });
        }
        
        function collides(a, b) {
          return a.x*16 < b.x + b.width &&
            a.x*16 + a.width > b.x &&
            a.y*16 < b.y + b.height &&
            a.y*16 + a.height > b.y;
        }
		
      
        function handleCollisions() {
          playerBullets.forEach(function(bullet) {
            enemies.forEach(function(enemy) {
              if(collides(bullet, enemy)) {
                enemy.explode();
                bullet.active = false;
              }
            });
          });
        
          enemies.forEach(function(enemy) {
            if(collides(enemy, player)) {
              enemy.explode();
              player.explode();
            }
          });
        }
        
        player.explode = function() {
          this.active = false;
          // Extra Credit: Add an explosion graphic and then end the game
        };
        
        player.sprite = Sprite("player");
        
        player.draw = function(cam) {
		  //canvas.globalCompositeOperation = 'source-in';
          this.sprite.draw(canvas, (this.x-cam.x)*16, (this.y-cam.y)*16);
		  //canvas.globalCompositeOperation = 'source-over';
        };
      //]]>
    </script>
  </body>
</html>
